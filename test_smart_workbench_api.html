<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ’è¯¾å·¥ä½œå°APIæµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .loading { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 3px; 
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª æ™ºèƒ½æ’è¯¾å·¥ä½œå° API è¿æ¥æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>ğŸ“‹ ç¯å¢ƒé…ç½®æ£€æŸ¥</h3>
        <div id="envCheck">æ£€æŸ¥ä¸­...</div>
    </div>

    <div class="test-section">
        <h3>ğŸ¢ æµ‹è¯•åŸºç¡€æ•°æ®åŠ è½½</h3>
        <button onclick="testBaseData()">æµ‹è¯•åŸºç¡€æ•°æ®åŠ è½½</button>
        <div id="baseDataResult"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“… æµ‹è¯•è¯¾è¡¨è®¡åˆ’åˆ—è¡¨</h3>
        <button onclick="testSchedulePlans()">è·å–è¯¾è¡¨è®¡åˆ’åˆ—è¡¨</button>
        <div id="schedulePlansResult"></div>
    </div>

    <div class="test-section">
        <h3>âœ¨ æµ‹è¯•åˆ›å»ºè¯¾è¡¨è®¡åˆ’</h3>
        <button onclick="testCreatePlan()">åˆ›å»ºæµ‹è¯•è®¡åˆ’</button>
        <div id="createPlanResult"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“š æµ‹è¯•æ‰¹é‡æ’è¯¾åˆ›å»º</h3>
        <button onclick="testBatchSchedules()">æµ‹è¯•æ‰¹é‡æ’è¯¾</button>
        <div id="batchSchedulesResult"></div>
    </div>

    <script>
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // éœ€è¦æ›¿æ¢ä¸ºå®é™…URL
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // éœ€è¦æ›¿æ¢ä¸ºå®é™…å¯†é’¥
        
        let supabase;
        
        // æ£€æŸ¥ç¯å¢ƒé…ç½®
        function checkEnvironment() {
            const envCheck = document.getElementById('envCheck');
            
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                envCheck.innerHTML = `
                    <div class="error">
                        <strong>âŒ ç¯å¢ƒé…ç½®ç¼ºå¤±</strong><br>
                        è¯·åœ¨æ­¤æ–‡ä»¶ä¸­è®¾ç½®æ­£ç¡®çš„ SUPABASE_URL å’Œ SUPABASE_ANON_KEY
                    </div>
                `;
                return false;
            }
            
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                envCheck.innerHTML = `
                    <div class="success">
                        <strong>âœ… ç¯å¢ƒé…ç½®æ­£å¸¸</strong><br>
                        Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ
                    </div>
                `;
                return true;
            } catch (error) {
                envCheck.innerHTML = `
                    <div class="error">
                        <strong>âŒ Supabase åˆå§‹åŒ–å¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
                return false;
            }
        }

        // æµ‹è¯•åŸºç¡€æ•°æ®åŠ è½½
        async function testBaseData() {
            const resultDiv = document.getElementById('baseDataResult');
            resultDiv.innerHTML = '<div class="loading">â³ æ­£åœ¨åŠ è½½åŸºç¡€æ•°æ®...</div>';
            
            try {
                // æµ‹è¯•ç­çº§æ•°æ®
                const { data: classes, error: classesError } = await supabase
                    .from('classes')
                    .select('id, name, description')
                    .eq('status', 'active')
                    .limit(5);
                
                if (classesError) throw classesError;

                // æµ‹è¯•ç§‘ç›®æ•°æ®
                const { data: subjects, error: subjectsError } = await supabase
                    .from('subjects')
                    .select('id, name, category')
                    .eq('status', 'active')
                    .limit(5);
                
                if (subjectsError) throw subjectsError;

                // æµ‹è¯•æ•™å¸ˆæ•°æ®
                const { data: teachers, error: teachersError } = await supabase
                    .from('profiles')
                    .select('id, full_name, username')
                    .eq('user_type', 'teacher')
                    .limit(5);
                
                if (teachersError) throw teachersError;

                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>âœ… åŸºç¡€æ•°æ®åŠ è½½æˆåŠŸ</strong><br>
                        ç­çº§: ${classes?.length || 0} ä¸ª<br>
                        ç§‘ç›®: ${subjects?.length || 0} ä¸ª<br>
                        æ•™å¸ˆ: ${teachers?.length || 0} ä¸ª<br>
                        <details>
                            <summary>æŸ¥çœ‹è¯¦ç»†æ•°æ®</summary>
                            <pre>${JSON.stringify({ classes, subjects, teachers }, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>âŒ åŸºç¡€æ•°æ®åŠ è½½å¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // æµ‹è¯•è¯¾è¡¨è®¡åˆ’åˆ—è¡¨
        async function testSchedulePlans() {
            const resultDiv = document.getElementById('schedulePlansResult');
            resultDiv.innerHTML = '<div class="loading">â³ æ­£åœ¨è·å–è¯¾è¡¨è®¡åˆ’...</div>';
            
            try {
                const { data, error } = await supabase.rpc('get_schedule_plans_with_stats', {
                    p_limit: 10,
                    p_offset: 0,
                    p_status: 'active'
                });

                if (error) throw error;

                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>âœ… è¯¾è¡¨è®¡åˆ’è·å–æˆåŠŸ</strong><br>
                        æ‰¾åˆ° ${data?.length || 0} ä¸ªæ´»è·ƒè®¡åˆ’<br>
                        <details>
                            <summary>æŸ¥çœ‹è¯¦ç»†æ•°æ®</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>âŒ è¯¾è¡¨è®¡åˆ’è·å–å¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // æµ‹è¯•åˆ›å»ºè¯¾è¡¨è®¡åˆ’
        async function testCreatePlan() {
            const resultDiv = document.getElementById('createPlanResult');
            resultDiv.innerHTML = '<div class="loading">â³ æ­£åœ¨åˆ›å»ºæµ‹è¯•è®¡åˆ’...</div>';
            
            try {
                // é¦–å…ˆè·å–åŸºç¡€æ•°æ®ç”¨äºåˆ›å»º
                const { data: classes } = await supabase
                    .from('classes').select('id').limit(1);
                const { data: subjects } = await supabase
                    .from('subjects').select('id').limit(1);
                const { data: teachers } = await supabase
                    .from('profiles').select('id').eq('user_type', 'teacher').limit(1);

                if (!classes?.[0] || !subjects?.[0] || !teachers?.[0]) {
                    throw new Error('ç¼ºå°‘åŸºç¡€æ•°æ®ï¼šéœ€è¦è‡³å°‘æœ‰ä¸€ä¸ªç­çº§ã€ç§‘ç›®å’Œæ•™å¸ˆ');
                }

                const testPlanData = {
                    p_plan_name: `æµ‹è¯•è®¡åˆ’_${Date.now()}`,
                    p_plan_description: 'è¿™æ˜¯ä¸€ä¸ªAPIæµ‹è¯•åˆ›å»ºçš„è¯¾è¡¨è®¡åˆ’',
                    p_class_id: classes[0].id,
                    p_subject_id: subjects[0].id,
                    p_teacher_id: teachers[0].id,
                    p_start_date: '2025-02-01',
                    p_end_date: '2025-06-30',
                    p_additional_student_ids: []
                };

                const { data, error } = await supabase.rpc('create_schedule_plan_with_participants', testPlanData);

                if (error) throw error;

                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>âœ… è¯¾è¡¨è®¡åˆ’åˆ›å»ºæˆåŠŸ</strong><br>
                        è®¡åˆ’ID: ${data.plan_id}<br>
                        <details>
                            <summary>æŸ¥çœ‹è¯¦ç»†æ•°æ®</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>âŒ è¯¾è¡¨è®¡åˆ’åˆ›å»ºå¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // æµ‹è¯•æ‰¹é‡æ’è¯¾åˆ›å»º
        async function testBatchSchedules() {
            const resultDiv = document.getElementById('batchSchedulesResult');
            resultDiv.innerHTML = '<div class="loading">â³ æ­£åœ¨æµ‹è¯•æ‰¹é‡æ’è¯¾...</div>';
            
            try {
                // é¦–å…ˆè·å–ä¸€ä¸ªå­˜åœ¨çš„è®¡åˆ’
                const { data: plans } = await supabase.rpc('get_schedule_plans_with_stats', {
                    p_limit: 1,
                    p_status: 'active'
                });

                if (!plans?.[0]) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°æ´»è·ƒçš„è¯¾è¡¨è®¡åˆ’ï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªè®¡åˆ’');
                }

                const planId = plans[0].id;
                const testSchedules = [
                    {
                        schedule_date: '2025-02-10',
                        start_time: '09:00:00',
                        end_time: '10:30:00',
                        lesson_title: 'APIæµ‹è¯•è¯¾ç¨‹1',
                        lesson_description: 'è¿™æ˜¯é€šè¿‡APIæµ‹è¯•åˆ›å»ºçš„è¯¾ç¨‹',
                        location: 'æµ‹è¯•æ•™å®¤A',
                        status: 'scheduled',
                        notes: null
                    },
                    {
                        schedule_date: '2025-02-12',
                        start_time: '14:00:00',
                        end_time: '15:30:00',
                        lesson_title: 'APIæµ‹è¯•è¯¾ç¨‹2',
                        lesson_description: 'è¿™æ˜¯é€šè¿‡APIæµ‹è¯•åˆ›å»ºçš„ç¬¬äºŒèŠ‚è¯¾ç¨‹',
                        location: 'æµ‹è¯•æ•™å®¤B',
                        status: 'scheduled',
                        notes: null
                    }
                ];

                const { data, error } = await supabase.rpc('create_plan_schedules_batch', {
                    p_plan_id: planId,
                    p_schedules: testSchedules
                });

                if (error) throw error;

                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>âœ… æ‰¹é‡æ’è¯¾åˆ›å»ºæˆåŠŸ</strong><br>
                        æˆåŠŸ: ${data.success_count} èŠ‚è¯¾<br>
                        å¤±è´¥: ${data.error_count} èŠ‚è¯¾<br>
                        <details>
                            <summary>æŸ¥çœ‹è¯¦ç»†ç»“æœ</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>âŒ æ‰¹é‡æ’è¯¾åˆ›å»ºå¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç¯å¢ƒ
        window.onload = function() {
            checkEnvironment();
        };
    </script>
</body>
</html> 