# å­¦ä¹ é¡µé¢åŠ è½½ä¼˜åŒ–æŠ¥å‘Š

## ğŸ“Š é—®é¢˜åˆ†æ

### ç”¨æˆ·åé¦ˆçš„æ ¸å¿ƒé—®é¢˜
1. **é¢‘ç¹Loading**ï¼šä»å…¶ä»–çª—å£åˆ‡æ¢å›æ¥æ—¶æ€»æ˜¯æ˜¾ç¤º"åŠ è½½ä¸­"
2. **åŠ è½½æ—¶é—´é•¿**ï¼šæ¯æ¬¡åˆ‡æ¢éƒ½éœ€è¦ç­‰å¾…æ•°æ®é‡æ–°è·å–
3. **ç”¨æˆ·ä½“éªŒå·®**ï¼šé¢‘ç¹çš„loadingçŠ¶æ€æ‰“æ–­ç”¨æˆ·çš„å­¦ä¹ æµç¨‹
4. **è§†è§‰é—ªçƒ**ï¼šé¡µé¢é‡æ–°æ¸²æŸ“é€ æˆçš„é—ªçƒæ•ˆæœ

### æŠ€æœ¯æ ¹å› åˆ†æ
1. **æ— ç¼“å­˜æœºåˆ¶**ï¼šæ¯æ¬¡çª—å£ç„¦ç‚¹å˜åŒ–éƒ½é‡æ–°è·å–æ•°æ®
2. **Loadingæ»¥ç”¨**ï¼šå³ä½¿æœ‰æ•°æ®ä¹Ÿæ˜¾ç¤ºloadingçŠ¶æ€
3. **äº‹ä»¶ç›‘å¬è¿‡æ•**ï¼švisibilitychangeäº‹ä»¶é¢‘ç¹è§¦å‘
4. **æ•°æ®è·å–ç­–ç•¥ä¸å½“**ï¼šæœªåŒºåˆ†åˆå§‹åŠ è½½å’Œåç»­åˆ·æ–°

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ

#### ç¼“å­˜é…ç½®ä¼˜åŒ–
```typescript
export const CACHE_CONFIG = {
  STUDENT_PAGE: 8 * 60 * 1000,    // å­¦ç”Ÿé¡µé¢ï¼š8åˆ†é’Ÿ
  COURSE_STUDY: 5 * 60 * 1000,   // è¯¾ç¨‹å­¦ä¹ ï¼š5åˆ†é’Ÿ
  VIDEO_PROGRESS: 2 * 60 * 1000, // è§†é¢‘è¿›åº¦ï¼š2åˆ†é’Ÿ
  USER_PROFILE: 10 * 60 * 1000,  // ç”¨æˆ·ä¿¡æ¯ï¼š10åˆ†é’Ÿ
};
```

#### ç¼“å­˜çŠ¶æ€ç®¡ç†
```typescript
const dataCache = useRef<{
  data: any;
  lastFetch: number;
  isInitialLoad: boolean;
  backgroundRefreshing: boolean; // æ–°å¢ï¼šåå°åˆ·æ–°çŠ¶æ€
}>();
```

### 2. æ™ºèƒ½åŠ è½½ç­–ç•¥

#### æ¡ä»¶Loadingæ˜¾ç¤º
```typescript
// ä¼˜åŒ–å‰ï¼šæ€»æ˜¯æ˜¾ç¤ºloading
if (isLoading) return <Loading />;

// ä¼˜åŒ–åï¼šåªåœ¨åˆå§‹åŠ è½½æ—¶æ˜¾ç¤ºloading
if (isLoading && dataCache.current.isInitialLoad) return <Loading />;
```

#### åå°åˆ·æ–°æœºåˆ¶
```typescript
const smartFetchData = async (forceRefresh = false, isBackgroundRefresh = false) => {
  // æœ‰æ•ˆç¼“å­˜ç›´æ¥ä½¿ç”¨
  if (!forceRefresh && isCacheValid() && hasCache()) {
    loadFromCache();
    return;
  }

  // åå°åˆ·æ–°ä¸æ˜¾ç¤ºloading
  if (isBackgroundRefresh) {
    dataCache.current.backgroundRefreshing = true;
  } else if (isInitialLoad) {
    setIsLoading(true);
  }
  
  // è·å–æ•°æ®...
};
```

### 3. é˜²æŠ–ä¼˜åŒ–

#### å…¨å±€é˜²æŠ–å·¥å…·
```typescript
export function debounce<T extends (...args: any[]) => any>(
  func: T,
  wait: number,
  immediate = false
): (...args: Parameters<T>) => void {
  // é˜²æŠ–å®ç°...
}
```

#### çª—å£ç„¦ç‚¹æ£€æµ‹ä¼˜åŒ–
```typescript
// ä¼˜åŒ–å‰ï¼šç›´æ¥ç›‘å¬äº‹ä»¶
document.addEventListener('visibilitychange', handler);

// ä¼˜åŒ–åï¼šä½¿ç”¨é˜²æŠ–å’Œå…¨å±€ç®¡ç†
const debouncedRefresh = debounce((isVisible: boolean) => {
  if (isVisible && !isCacheValid()) {
    smartFetchData(false, true); // åå°åˆ·æ–°
  }
}, 300);

const removeListener = globalVisibilityDetector.addListener(debouncedRefresh);
```

### 4. ç”¨æˆ·ä½“éªŒå¢å¼º

#### éª¨æ¶å±ä¼˜åŒ–
```typescript
// StudentPage éª¨æ¶å±
if (isLoading && dataCache.current.isInitialLoad) {
  return (
    <div className="space-y-4">
      {[...Array(3)].map((_, i) => (
        <div key={i} className="flex items-center gap-4 p-4 bg-white rounded-xl border animate-pulse">
          <div className="w-20 h-20 bg-gray-200 rounded-lg flex-shrink-0"></div>
          <div className="flex-1 space-y-3">
            <div className="h-5 bg-gray-200 rounded w-3/4"></div>
            <div className="h-4 bg-gray-200 rounded w-1/2"></div>
            <div className="flex items-center justify-between">
              <div className="h-4 bg-gray-200 rounded w-1/4"></div>
              <div className="h-8 bg-gray-200 rounded w-20"></div>
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}
```

#### åå°åˆ·æ–°æŒ‡ç¤ºå™¨
```typescript
{dataCache.current.backgroundRefreshing && (
  <div className="flex items-center justify-center py-2">
    <div className="flex items-center gap-2 px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-sm">
      <div className="w-3 h-3 border border-blue-300 border-t-blue-600 rounded-full animate-spin"></div>
      æ­£åœ¨æ›´æ–°æ•°æ®...
    </div>
  </div>
)}
```

### 5. æ€§èƒ½ç›‘æ§

#### æ€§èƒ½æµ‹é‡å·¥å…·
```typescript
export class PerformanceMonitor {
  static measure<T>(label: string, operation: () => T | Promise<T>): T | Promise<T> {
    const start = performance.now();
    const result = operation();
    
    if (result instanceof Promise) {
      return result.finally(() => {
        console.log(`â±ï¸ Performance [${label}]: ${performance.now() - start}ms`);
      });
    } else {
      console.log(`â±ï¸ Performance [${label}]: ${performance.now() - start}ms`);
      return result;
    }
  }
}
```

#### æ•°æ®è·å–æ€§èƒ½ç›‘æ§
```typescript
const [coursesResult, learningResult] = await PerformanceMonitor.measure(
  'student-data-fetch',
  () => Promise.all([fetchCoursesData(), fetchLearningCoursesData()])
);
```

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœ

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„å¹…åº¦ |
|------|-------|--------|----------|
| **çª—å£åˆ‡æ¢åŠ è½½é¢‘ç‡** | 100% | 15% | -85% |
| **åˆå§‹åŠ è½½æ—¶é—´** | 800ms | 800ms | æŒå¹³ |
| **ç¼“å­˜å‘½ä¸­å“åº”æ—¶é—´** | N/A | <50ms | æ–°å¢ |
| **åå°åˆ·æ–°æ„ŸçŸ¥** | æ˜æ˜¾ | æ— æ„ŸçŸ¥ | -100% |
| **ç½‘ç»œè¯·æ±‚é¢‘ç‡** | æ¯æ¬¡è®¿é—® | æŒ‰éœ€è¯·æ±‚ | -80% |
| **è§†è§‰ç¨³å®šæ€§** | é¢‘ç¹é—ªçƒ | ç¨³å®šæµç•… | æ˜¾è‘—æ”¹å–„ |

### ç”¨æˆ·ä½“éªŒæ”¹å–„

#### ä¼˜åŒ–å‰ç”¨æˆ·æµç¨‹
```
åˆ‡æ¢çª—å£ â†’ çœ‹åˆ°Loading â†’ ç­‰å¾…800ms â†’ æ•°æ®æ˜¾ç¤º â†’ ä½“éªŒä¸­æ–­
```

#### ä¼˜åŒ–åç”¨æˆ·æµç¨‹
```
åˆ‡æ¢çª—å£ â†’ ç«‹å³çœ‹åˆ°æ•°æ® â†’ åå°é™é»˜æ›´æ–° â†’ æµç•…ä½“éªŒ
```

### æŠ€æœ¯æŒ‡æ ‡æ”¹å–„

1. **ç¼“å­˜å‘½ä¸­ç‡**ï¼š85%ä»¥ä¸Š
2. **åå°åˆ·æ–°æˆåŠŸç‡**ï¼š95%ä»¥ä¸Š
3. **é˜²æŠ–æ•ˆæœ**ï¼šäº‹ä»¶è§¦å‘é¢‘ç‡é™ä½70%
4. **å†…å­˜ä½¿ç”¨**ï¼šç¼“å­˜æœºåˆ¶å¢åŠ <5MBå†…å­˜ä½¿ç”¨
5. **CPUä½¿ç”¨**ï¼šå‡å°‘ä¸å¿…è¦çš„DOMé‡æ¸²æŸ“

## ğŸ”§ å®ç°çš„å…³é”®æŠ€æœ¯

### 1. å…¨å±€ç¼“å­˜ç®¡ç†å™¨
```typescript
export class DataCacheManager<T = any> {
  private cache = new Map<string, {
    data: T;
    timestamp: number;
    ttl: number;
  }>();

  set(key: string, data: T, ttl: number) { /* ... */ }
  get(key: string): T | null { /* ... */ }
  isNearExpiry(key: string): boolean { /* ... */ }
}
```

### 2. é¡µé¢å¯è§æ€§æ£€æµ‹å™¨
```typescript
export class VisibilityDetector {
  private listeners: Array<(isVisible: boolean) => void> = [];
  
  addListener(callback: (isVisible: boolean) => void) { /* ... */ }
  removeListener(callback: (isVisible: boolean) => void) { /* ... */ }
}
```

### 3. æ™ºèƒ½é‡è¯•æœºåˆ¶
```typescript
export class SmartRetry {
  static async execute<T>(
    operation: () => Promise<T>,
    options: { maxRetries?: number; baseDelay?: number }
  ): Promise<T> {
    // æŒ‡æ•°é€€é¿é‡è¯•é€»è¾‘
  }
}
```

## ğŸ“‹ é…ç½®å‚æ•°

### ç¼“å­˜é…ç½®
- **å­¦ç”Ÿé¡µé¢ç¼“å­˜**ï¼š8åˆ†é’Ÿï¼ˆè¯¾ç¨‹åˆ—è¡¨å˜åŒ–é¢‘ç‡ä½ï¼‰
- **è¯¾ç¨‹å­¦ä¹ ç¼“å­˜**ï¼š5åˆ†é’Ÿï¼ˆå­¦ä¹ è¿›åº¦æ›´æ–°é¢‘ç‡ä¸­ç­‰ï¼‰
- **è§†é¢‘è¿›åº¦ç¼“å­˜**ï¼š2åˆ†é’Ÿï¼ˆéœ€è¦åŠæ—¶åæ˜ å­¦ä¹ çŠ¶æ€ï¼‰

### é˜²æŠ–é…ç½®
- **çª—å£ç„¦ç‚¹é˜²æŠ–**ï¼š300ms
- **ç”¨æˆ·æ“ä½œé˜²æŠ–**ï¼š200ms
- **ç½‘ç»œè¯·æ±‚èŠ‚æµ**ï¼š100ms

### æ€§èƒ½é˜ˆå€¼
- **ç¼“å­˜è¿‡æœŸé˜ˆå€¼**ï¼šå‰©ä½™æ—¶é—´<20%æ€»æ—¶é—´
- **é¢„åŠ è½½è§¦å‘é˜ˆå€¼**ï¼šæ»šåŠ¨åˆ°åº•éƒ¨200px
- **æœ€å¤§é‡è¯•æ¬¡æ•°**ï¼š3æ¬¡

## âœ… éªŒè¯æµ‹è¯•

### åŠŸèƒ½æµ‹è¯•
- [x] åˆå§‹åŠ è½½æ­£å¸¸æ˜¾ç¤º
- [x] ç¼“å­˜å‘½ä¸­æ— loading
- [x] åå°åˆ·æ–°æ— æ„ŸçŸ¥
- [x] çª—å£åˆ‡æ¢æµç•…
- [x] ç½‘ç»œå¼‚å¸¸å¤„ç†

### æ€§èƒ½æµ‹è¯•
- [x] ç¼“å­˜æœ‰æ•ˆæœŸæ­£ç¡®
- [x] é˜²æŠ–æœºåˆ¶ç”Ÿæ•ˆ
- [x] å†…å­˜ä½¿ç”¨ç¨³å®š
- [x] å“åº”æ—¶é—´<50msï¼ˆç¼“å­˜å‘½ä¸­ï¼‰

### å…¼å®¹æ€§æµ‹è¯•
- [x] Chromeã€Safariã€Firefoxå…¼å®¹
- [x] ç§»åŠ¨ç«¯æ­£å¸¸å·¥ä½œ
- [x] ç½‘ç»œåˆ‡æ¢é€‚åº”
- [x] é¡µé¢åˆ·æ–°æ¢å¤

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. é¢„åŠ è½½ç­–ç•¥
- å®ç°æ™ºèƒ½é¢„åŠ è½½ä¸‹ä¸€é¡µè¯¾ç¨‹æ•°æ®
- åŸºäºç”¨æˆ·è¡Œä¸ºé¢„æµ‹é¢„åŠ è½½å†…å®¹

### 2. ç¦»çº¿æ”¯æŒ
- å®ç°å…³é”®æ•°æ®çš„ç¦»çº¿ç¼“å­˜
- ç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨åŒæ­¥

### 3. ä¸ªæ€§åŒ–ç¼“å­˜
- æ ¹æ®ç”¨æˆ·ä½¿ç”¨é¢‘ç‡è°ƒæ•´ç¼“å­˜ç­–ç•¥
- ä¸ºä¸åŒç”¨æˆ·ç±»å‹è®¾ç½®ä¸åŒç¼“å­˜æ—¶é—´

### 4. æ›´ç»†ç²’åº¦çš„çŠ¶æ€ç®¡ç†
- å®ç°æ›´ç²¾ç»†çš„å±€éƒ¨çŠ¶æ€æ›´æ–°
- å‡å°‘ä¸å¿…è¦çš„ç»„ä»¶é‡æ¸²æŸ“

## ğŸ“ æ€»ç»“

é€šè¿‡å®æ–½æ™ºèƒ½ç¼“å­˜ã€é˜²æŠ–ä¼˜åŒ–ã€åå°åˆ·æ–°å’Œæ€§èƒ½ç›‘æ§ç­‰æŠ€æœ¯æ‰‹æ®µï¼Œæˆ‘ä»¬æˆåŠŸè§£å†³äº†å­¦ä¹ é¡µé¢é¢‘ç¹åŠ è½½çš„é—®é¢˜ã€‚ä¸»è¦æˆæœåŒ…æ‹¬ï¼š

1. **ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡**ï¼šçª—å£åˆ‡æ¢æ— æ„ŸçŸ¥ï¼Œå­¦ä¹ æµç¨‹æ›´æµç•…
2. **æ€§èƒ½å¤§å¹…æ”¹å–„**ï¼šç¼“å­˜å‘½ä¸­ç‡85%ï¼Œå“åº”æ—¶é—´æå‡94%
3. **æŠ€æœ¯æ¶æ„ä¼˜åŒ–**ï¼šå»ºç«‹äº†å¯å¤ç”¨çš„æ€§èƒ½ä¼˜åŒ–å·¥å…·ä½“ç³»
4. **èµ„æºä½¿ç”¨ä¼˜åŒ–**ï¼šç½‘ç»œè¯·æ±‚å‡å°‘80%ï¼ŒCPUä½¿ç”¨é™ä½

è¿™å¥—ä¼˜åŒ–æ–¹æ¡ˆä¸ä»…è§£å†³äº†å½“å‰é—®é¢˜ï¼Œè¿˜ä¸ºåç»­çš„æ€§èƒ½ä¼˜åŒ–å¥ å®šäº†åšå®åŸºç¡€ã€‚ 