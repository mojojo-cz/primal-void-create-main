<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ’è¯¾å·¥ä½œå° - åˆ é™¤åŒæ­¥ä¿®å¤æŠ¥å‘Š</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #dc2626;
            text-align: center;
            margin-bottom: 30px;
        }
        .problem-section {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .problem-title {
            color: #dc2626;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .solution-section {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .solution-title {
            color: #16a34a;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .code-block {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .before-after {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .before, .after {
            padding: 15px;
            border-radius: 6px;
        }
        .before {
            background: #fee2e2;
            border: 1px solid #fecaca;
        }
        .after {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
        }
        .label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .before .label {
            color: #dc2626;
        }
        .after .label {
            color: #059669;
        }
        .highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .check-mark {
            color: #16a34a;
            font-weight: bold;
        }
        .step {
            background: #eff6ff;
            border: 1px solid #dbeafe;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .step-title {
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .workflow {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .workflow-title {
            color: #374151;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 16px;
        }
        ul li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ™ºèƒ½æ’è¯¾å·¥ä½œå° - åˆ é™¤åŒæ­¥ä¿®å¤æŠ¥å‘Š</h1>
        
        <div class="problem-section">
            <div class="problem-title">âŒ é—®é¢˜æè¿°</div>
            <p><strong>ç”¨æˆ·åé¦ˆï¼š</strong>é€‰æ‹©å·²æœ‰è¯¾ç¨‹ï¼Œåœ¨é¢„è§ˆå¾®è°ƒåŒºåˆ é™¤è¯¾ç¨‹å¹¶ä¿å­˜åï¼Œæ•°æ®åº“å¹¶æ²¡æœ‰æ›´æ–°æœ€æ–°æ•°æ®ã€‚</p>
            
            <div class="workflow">
                <div class="workflow-title">é—®é¢˜å¤ç°æ­¥éª¤ï¼š</div>
                <ol>
                    <li>æ‰“å¼€æ™ºèƒ½æ’è¯¾å·¥ä½œå°</li>
                    <li>é€‰æ‹©ä¸€ä¸ªå·²æœ‰çš„è¯¾è¡¨è®¡åˆ’</li>
                    <li>ç³»ç»ŸåŠ è½½è¯¥è¯¾è¡¨ä¸‹çš„å·²æœ‰è¯¾ç¨‹åˆ°é¢„è§ˆåŒº</li>
                    <li>åœ¨é¢„è§ˆå¾®è°ƒåŒºåˆ é™¤ä¸€äº›è¯¾ç¨‹</li>
                    <li>ç‚¹å‡»ä¿å­˜</li>
                    <li><span class="highlight">ç»“æœï¼šåˆ é™¤çš„è¯¾ç¨‹ä»ç„¶å­˜åœ¨äºæ•°æ®åº“ä¸­</span></li>
                </ol>
            </div>

            <div class="step">
                <div class="step-title">æ ¹æœ¬åŸå› åˆ†æï¼š</div>
                <ul>
                    <li>åˆ é™¤æ“ä½œåªä»å‰ç«¯é¢„è§ˆåˆ—è¡¨ä¸­ç§»é™¤äº†è¯¾ç¨‹</li>
                    <li>æ²¡æœ‰è®°å½•å“ªäº›å·²æœ‰è¯¾ç¨‹è¢«åˆ é™¤</li>
                    <li>ä¿å­˜æ—¶åªå¤„ç†äº†æ–°å¢å’Œæ›´æ–°ï¼Œå¿½ç•¥äº†åˆ é™¤æ“ä½œ</li>
                    <li>ä»£ç ä¸­æœ‰æ³¨é‡Š"è¿™é‡Œå¯ä»¥æ·»åŠ åˆ é™¤é€»è¾‘"ä½†æ²¡æœ‰å®ç°</li>
                </ul>
            </div>
        </div>

        <div class="solution-section">
            <div class="solution-title">âœ… è§£å†³æ–¹æ¡ˆ</div>
            <p>å®ç°å®Œæ•´çš„åˆ é™¤åŒæ­¥æœºåˆ¶ï¼Œç¡®ä¿å‰ç«¯åˆ é™¤æ“ä½œèƒ½æ­£ç¡®åŒæ­¥åˆ°æ•°æ®åº“ã€‚</p>
            
            <div class="step">
                <div class="step-title">æ­¥éª¤1ï¼šæ·»åŠ åˆ é™¤çŠ¶æ€è·Ÿè¸ª</div>
                <div class="before-after">
                    <div class="before">
                        <div class="label">ä¿®æ”¹å‰</div>
                        <div class="code-block">
// åªæœ‰é¢„è§ˆåˆ—è¡¨çŠ¶æ€
const [previewSchedules, setPreviewSchedules] = 
  useState&lt;PreviewScheduleItem[]&gt;([]);
                        </div>
                    </div>
                    <div class="after">
                        <div class="label">ä¿®æ”¹å</div>
                        <div class="code-block">
// é¢„è§ˆåˆ—è¡¨çŠ¶æ€
const [previewSchedules, setPreviewSchedules] = 
  useState&lt;PreviewScheduleItem[]&gt;([]);
// åˆ é™¤çš„å·²æœ‰è¯¾ç¨‹IDåˆ—è¡¨
const [deletedScheduleIds, setDeletedScheduleIds] = 
  useState&lt;string[]&gt;([]);
                        </div>
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-title">æ­¥éª¤2ï¼šå¢å¼ºåˆ é™¤å‡½æ•°</div>
                <div class="before-after">
                    <div class="before">
                        <div class="label">ä¿®æ”¹å‰</div>
                        <div class="code-block">
const removeFromPreview = (id: string) => {
  setPreviewSchedules(prev => 
    prev.filter(item => item.id !== id)
  );
};
                        </div>
                    </div>
                    <div class="after">
                        <div class="label">ä¿®æ”¹å</div>
                        <div class="code-block">
const removeFromPreview = (id: string) => {
  // æ‰¾åˆ°è¦åˆ é™¤çš„è¯¾ç¨‹
  const scheduleToRemove = previewSchedules.find(
    item => item.id === id
  );
  
  // å¦‚æœæ˜¯å·²æœ‰è¯¾ç¨‹ï¼Œè®°å½•å…¶IDç”¨äºåç»­åˆ é™¤
  if (scheduleToRemove && scheduleToRemove.isNew === false) {
    setDeletedScheduleIds(prev => [...prev, id]);
  }
  
  // ä»é¢„è§ˆåˆ—è¡¨ä¸­ç§»é™¤
  setPreviewSchedules(prev => 
    prev.filter(item => item.id !== id)
  );
};
                        </div>
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-title">æ­¥éª¤3ï¼šå®Œå–„ä¿å­˜é€»è¾‘</div>
                <div class="before-after">
                    <div class="before">
                        <div class="label">ä¿®æ”¹å‰</div>
                        <div class="code-block">
// åˆ†åˆ«å¤„ç†æ–°å¢å’Œæ›´æ–°çš„æ’è¯¾
const newSchedules = previewSchedules.filter(
  item => item.isNew !== false
);
const updatedSchedules = previewSchedules.filter(
  item => item.isNew === false && item.isEdited
);
const deletedScheduleIds: string[] = []; 
// è¿™é‡Œå¯ä»¥æ·»åŠ åˆ é™¤é€»è¾‘

// å¤„ç†åˆ é™¤çš„æ’è¯¾ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
for (const scheduleId of deletedScheduleIds) {
  // åˆ é™¤é€»è¾‘ä½†æ²¡æœ‰successCount++
}
                        </div>
                    </div>
                    <div class="after">
                        <div class="label">ä¿®æ”¹å</div>
                        <div class="code-block">
// åˆ†åˆ«å¤„ç†æ–°å¢å’Œæ›´æ–°çš„æ’è¯¾
const newSchedules = previewSchedules.filter(
  item => item.isNew !== false
);
const updatedSchedules = previewSchedules.filter(
  item => item.isNew === false && item.isEdited
);
// ä½¿ç”¨çŠ¶æ€ä¸­è®°å½•çš„åˆ é™¤è¯¾ç¨‹IDåˆ—è¡¨

// å¤„ç†åˆ é™¤çš„æ’è¯¾
for (const scheduleId of deletedScheduleIds) {
  try {
    const { error: deleteError } = await supabase
      .from('schedules')
      .delete()
      .eq('id', scheduleId);

    if (deleteError) {
      throw deleteError;
    }
    successCount++; // è®°å½•æˆåŠŸåˆ é™¤
  } catch (error) {
    console.error(`åˆ é™¤æ’è¯¾å¤±è´¥:`, error);
    errorCount++;
  }
}
                        </div>
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-title">æ­¥éª¤4ï¼šä¼˜åŒ–æˆåŠŸæç¤º</div>
                <div class="before-after">
                    <div class="before">
                        <div class="label">ä¿®æ”¹å‰</div>
                        <div class="code-block">
toast({
  title: "ä¿å­˜æˆåŠŸ",
  description: `æˆåŠŸ${actionText}äº† ${successCount} èŠ‚è¯¾`
});
                        </div>
                    </div>
                    <div class="after">
                        <div class="label">ä¿®æ”¹å</div>
                        <div class="code-block">
const operationSummary = [];
if (newSchedules.length > 0) 
  operationSummary.push(`æ–°å¢ ${newSchedules.length} èŠ‚`);
if (updatedSchedules.length > 0) 
  operationSummary.push(`æ›´æ–° ${updatedSchedules.length} èŠ‚`);
if (deletedScheduleIds.length > 0) 
  operationSummary.push(`åˆ é™¤ ${deletedScheduleIds.length} èŠ‚`);

toast({
  title: "ä¿å­˜æˆåŠŸ",
  description: `æˆåŠŸ${actionText}è¯¾ç¨‹ï¼š${operationSummary.join('ï¼Œ')}`
});
                        </div>
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-title">æ­¥éª¤5ï¼šçŠ¶æ€æ¸…ç†</div>
                <p>åœ¨é‡ç½®å·¥ä½œå°å’Œé€‰æ‹©æ–°è¯¾è¡¨æ—¶æ¸…ç©ºåˆ é™¤åˆ—è¡¨ï¼š</p>
                <div class="code-block">
// åœ¨ resetWorkbench() å’Œ handlePlanSelect() ä¸­æ·»åŠ 
setDeletedScheduleIds([]);
                </div>
            </div>
        </div>

        <div class="solution-section">
            <div class="solution-title">ğŸ¯ ä¿®å¤æ•ˆæœ</div>
            
            <div class="workflow">
                <div class="workflow-title">ä¿®å¤åçš„å®Œæ•´å·¥ä½œæµç¨‹ï¼š</div>
                <ol>
                    <li><span class="check-mark">âœ“</span> é€‰æ‹©å·²æœ‰è¯¾è¡¨ â†’ åŠ è½½è¯¾ç¨‹åˆ°é¢„è§ˆåŒºï¼ˆisNew: falseï¼‰</li>
                    <li><span class="check-mark">âœ“</span> åˆ é™¤è¯¾ç¨‹ â†’ è®°å½•å·²æœ‰è¯¾ç¨‹IDåˆ°deletedScheduleIds</li>
                    <li><span class="check-mark">âœ“</span> ç¼–è¾‘è¯¾ç¨‹ â†’ æ ‡è®°ä¸ºå·²ç¼–è¾‘ï¼ˆisEdited: trueï¼‰</li>
                    <li><span class="check-mark">âœ“</span> æ·»åŠ æ–°è¯¾ç¨‹ â†’ æ ‡è®°ä¸ºæ–°å¢ï¼ˆisNew: trueï¼‰</li>
                    <li><span class="check-mark">âœ“</span> ä¿å­˜æ“ä½œ â†’ åˆ†åˆ«å¤„ç†æ–°å¢ã€æ›´æ–°ã€åˆ é™¤ä¸‰ç§æ“ä½œ</li>
                    <li><span class="check-mark">âœ“</span> æ•°æ®åº“åŒæ­¥ â†’ æ‰€æœ‰æ“ä½œéƒ½æ­£ç¡®åŒæ­¥åˆ°æ•°æ®åº“</li>
                </ol>
            </div>

            <div class="step">
                <div class="step-title">æ ¸å¿ƒæ”¹è¿›ï¼š</div>
                <ul>
                    <li><span class="check-mark">âœ“</span> <strong>åˆ é™¤è·Ÿè¸ª</strong>ï¼šæ–°å¢deletedScheduleIdsçŠ¶æ€è·Ÿè¸ªè¢«åˆ é™¤çš„å·²æœ‰è¯¾ç¨‹</li>
                    <li><span class="check-mark">âœ“</span> <strong>æ™ºèƒ½è¯†åˆ«</strong>ï¼šæ ¹æ®isNewå­—æ®µåŒºåˆ†æ–°è¯¾ç¨‹å’Œå·²æœ‰è¯¾ç¨‹</li>
                    <li><span class="check-mark">âœ“</span> <strong>å®Œæ•´åŒæ­¥</strong>ï¼šä¿å­˜æ—¶å¤„ç†æ–°å¢ã€æ›´æ–°ã€åˆ é™¤ä¸‰ç§æ“ä½œ</li>
                    <li><span class="check-mark">âœ“</span> <strong>çŠ¶æ€ç®¡ç†</strong>ï¼šåœ¨é€‚å½“æ—¶æœºæ¸…ç†åˆ é™¤åˆ—è¡¨ï¼Œé¿å…çŠ¶æ€æ±¡æŸ“</li>
                    <li><span class="check-mark">âœ“</span> <strong>ç”¨æˆ·åé¦ˆ</strong>ï¼šè¯¦ç»†çš„æ“ä½œç»“æœæç¤ºï¼ŒåŒ…å«å…·ä½“çš„æ“ä½œæ•°é‡</li>
                </ul>
            </div>
        </div>

        <div class="solution-section">
            <div class="solution-title">ğŸ”„ æµ‹è¯•éªŒè¯</div>
            <p>è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æµ‹è¯•ä¿®å¤æ•ˆæœï¼š</p>
            <ol>
                <li>é€‰æ‹©ä¸€ä¸ªåŒ…å«å¤šèŠ‚è¯¾ç¨‹çš„å·²æœ‰è¯¾è¡¨</li>
                <li>åœ¨é¢„è§ˆå¾®è°ƒåŒºåˆ é™¤å‡ èŠ‚è¯¾ç¨‹</li>
                <li>ç¼–è¾‘å‡ èŠ‚è¯¾ç¨‹çš„ä¿¡æ¯</li>
                <li>æ·»åŠ å‡ èŠ‚æ–°è¯¾ç¨‹</li>
                <li>ç‚¹å‡»ä¿å­˜</li>
                <li>æ£€æŸ¥æ•°æ®åº“ - åˆ é™¤çš„è¯¾ç¨‹åº”è¯¥å·²è¢«ç§»é™¤</li>
                <li>æ£€æŸ¥æˆåŠŸæç¤º - åº”æ˜¾ç¤º"æ–°å¢XèŠ‚ï¼Œæ›´æ–°YèŠ‚ï¼Œåˆ é™¤ZèŠ‚"</li>
            </ol>
        </div>

        <div class="workflow">
            <div class="workflow-title">æŠ€æœ¯ç»†èŠ‚æ€»ç»“ï¼š</div>
            <ul>
                <li><strong>æ–‡ä»¶ä¿®æ”¹</strong>ï¼šsrc/components/SmartScheduleWorkbench.tsx</li>
                <li><strong>æ–°å¢çŠ¶æ€</strong>ï¼šdeletedScheduleIds: string[]</li>
                <li><strong>ä¿®æ”¹å‡½æ•°</strong>ï¼šremoveFromPreview, handleSavePlan, resetWorkbench, handlePlanSelect</li>
                <li><strong>æ•°æ®åº“æ“ä½œ</strong>ï¼šDELETE FROM schedules WHERE id = ?</li>
                <li><strong>å‘åå…¼å®¹</strong>ï¼šå®Œå…¨å…¼å®¹ç°æœ‰åŠŸèƒ½ï¼Œåªå¢å¼ºåˆ é™¤åŒæ­¥</li>
            </ul>
        </div>
    </div>
</body>
</html> 