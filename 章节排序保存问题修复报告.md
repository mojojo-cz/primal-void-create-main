# ç« èŠ‚æ’åºä¿å­˜é—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šåœ¨è¯¾ç¨‹ç®¡ç†é¡µé¢ä¸­ï¼Œè°ƒæ•´ç« èŠ‚æ’åºåï¼Œæ’åºæ²¡æœ‰æˆåŠŸä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚æ£€æŸ¥Supabaseçš„`course_sections`è¡¨å‘ç°å¯¹åº”çš„`order`å­—æ®µå¹¶æ²¡æœ‰æ›´æ–°ã€‚

## é—®é¢˜åˆ†æ

é€šè¿‡æ·±å…¥åˆ†æä»£ç å’Œæ•°æ®åº“æ“ä½œï¼Œå‘ç°äº†ä»¥ä¸‹æ ¹æœ¬åŸå› ï¼š

### 1. **PostgreSQLä¿ç•™å­—å¤„ç†é—®é¢˜**

åœ¨Supabaseå®¢æˆ·ç«¯ä¸­ï¼Œå½“ä½¿ç”¨PostgreSQLä¿ç•™å­—ä½œä¸ºå­—æ®µåæ—¶ï¼Œéœ€è¦ç”¨åŒå¼•å·æ‹¬èµ·æ¥ã€‚`order`æ˜¯PostgreSQLçš„ä¿ç•™å­—ï¼Œåœ¨æ›´æ–°æ“ä½œä¸­å¿…é¡»å†™æˆ`"order"`ï¼Œå¦åˆ™ä¼šè¢«è¯†åˆ«ä¸ºSQLè¯­æ³•çš„ä¸€éƒ¨åˆ†ã€‚

**é—®é¢˜ä»£ç ï¼š**
```typescript
.update({ order: newOrder })  // âŒ é”™è¯¯ï¼šorderè¢«è¯†åˆ«ä¸ºSQLå…³é”®å­—
```

**æ­£ç¡®ä»£ç ï¼š**
```typescript
.update({ "order": newOrder })  // âœ… æ­£ç¡®ï¼šæ˜ç¡®æŒ‡å®šä¸ºå­—æ®µå
```

### 2. **å½±å“èŒƒå›´**

æ‰€æœ‰æ¶‰åŠ`order`å­—æ®µæ›´æ–°çš„æ“ä½œéƒ½å—åˆ°å½±å“ï¼š

1. **æ‹–æ‹½æ’åº** (`handleDragEnd`) - æ‰¹é‡æ›´æ–°ç« èŠ‚é¡ºåº
2. **æŒ‰é’®æ’åº** (`moveSectionUp`, `moveSectionDown`) - å•ä¸ªç« èŠ‚ä¸Šä¸‹ç§»åŠ¨
3. **ç« èŠ‚ç¼–è¾‘** (`handleSectionSubmit`) - ç¼–è¾‘ç« èŠ‚æ—¶ä¿®æ”¹é¡ºåº
4. **æ–°å¢è¯¾ç¨‹** (`handleSubmit`) - åˆ›å»ºè¯¾ç¨‹æ—¶æ’å…¥ç« èŠ‚
5. **è¾…åŠ©å‡½æ•°** (`reorderSections`) - ç« èŠ‚é‡æ’åº

### 3. **æ•°æ®åº“çº¦æŸéªŒè¯**

é€šè¿‡MCPæµ‹è¯•å‘ç°ï¼š
- ç›´æ¥SQLæ›´æ–°ï¼ˆä½¿ç”¨åŒå¼•å·ï¼‰å¯ä»¥æˆåŠŸ
- æœ‰å”¯ä¸€çº¦æŸ `idx_course_section_order` é˜²æ­¢åŒä¸€è¯¾ç¨‹ä¸‹é‡å¤çš„orderå€¼
- è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆä»£ç ä¸­ä½¿ç”¨ä¸´æ—¶orderå€¼æ¥é¿å…çº¦æŸå†²çª

## è§£å†³æ–¹æ¡ˆ

### ä¿®å¤æ‰€æœ‰orderå­—æ®µæ›´æ–°æ“ä½œ

**1. æ‹–æ‹½æ’åºä¿®å¤ï¼š**
```typescript
// handleDragEndå‡½æ•°ä¸­çš„ä¿®å¤
.update({ "order": 1000 + parseInt(section.id.slice(-6), 16) })
.update({ "order": index + 1 })
```

**2. æŒ‰é’®æ’åºä¿®å¤ï¼š**
```typescript
// moveSectionUpå’ŒmoveSectionDownå‡½æ•°ä¸­çš„ä¿®å¤
.update({ "order": 9999 })
.update({ "order": prevSection.order })
.update({ "order": tempOrder })
```

**3. ç« èŠ‚ç¼–è¾‘ä¿®å¤ï¼š**
```typescript
// handleSectionSubmitå‡½æ•°ä¸­çš„ä¿®å¤
.insert([{
  course_id: sectionDialog.courseId,
  title: sectionForm.title,
  description: sectionForm.description,
  "order": sectionForm.order,  // ä¿®å¤æ’å…¥
  video_id: sectionForm.video_id || null,
}])

.update({
  title: sectionForm.title,
  description: sectionForm.description,
  "order": sectionForm.order,  // ä¿®å¤æ›´æ–°
  video_id: sectionForm.video_id || null,
})
```

**4. æ–°å¢è¯¾ç¨‹ä¿®å¤ï¼š**
```typescript
// handleSubmitå‡½æ•°ä¸­çš„ä¿®å¤
const sections = form.sections.map((section, idx) => ({
  course_id: courseData.id,
  title: section.title,
  description: section.description,
  "order": section.order || idx + 1,  // ä¿®å¤æ‰¹é‡æ’å…¥
  video_id: section.video_id,
}));
```

**5. è¾…åŠ©å‡½æ•°ä¿®å¤ï¼š**
```typescript
// reorderSectionså‡½æ•°ä¸­çš„ä¿®å¤
.update({ "order": newOrder })
```

**6. æŸ¥è¯¢è¯­å¥ä¿®å¤ï¼š**
```typescript
// fetchCourseså’ŒfetchSectionså‡½æ•°ä¸­çš„ä¿®å¤
.order('"order"', { ascending: true })
```

## æŠ€æœ¯ç»†èŠ‚

### PostgreSQLä¿ç•™å­—åˆ—è¡¨
å¸¸è§çš„PostgreSQLä¿ç•™å­—åŒ…æ‹¬ï¼š
- `order` - æ’åºå…³é”®å­—
- `group` - åˆ†ç»„å…³é”®å­—  
- `select` - æŸ¥è¯¢å…³é”®å­—
- `where` - æ¡ä»¶å…³é”®å­—
- `from` - æ¥æºå…³é”®å­—

### Supabaseå®¢æˆ·ç«¯è§„åˆ™
1. **å­—æ®µåå¤„ç†**ï¼šå½“å­—æ®µåæ˜¯ä¿ç•™å­—æ—¶ï¼Œå¿…é¡»ç”¨åŒå¼•å·æ‹¬èµ·æ¥
2. **æŸ¥è¯¢è¯­å¥**ï¼šåœ¨`.select()`ä¸­ä¹Ÿéœ€è¦ä½¿ç”¨åŒå¼•å·ï¼š`"order"`
3. **æ’åºè¯­å¥**ï¼šåœ¨`.order()`ä¸­å‚æ•°å¯ä»¥ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²ï¼š`"order"`

### çº¦æŸå¤„ç†ç­–ç•¥
ä¸ºäº†é¿å…å”¯ä¸€çº¦æŸå†²çªï¼Œä½¿ç”¨ä¸¤é˜¶æ®µæ›´æ–°ï¼š
1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šå°†æ‰€æœ‰è¦æ›´æ–°çš„è®°å½•è®¾ç½®ä¸ºä¸´æ—¶orderå€¼
2. **ç¬¬äºŒé˜¶æ®µ**ï¼šè®¾ç½®æœ€ç»ˆçš„orderå€¼

## éªŒè¯æµ‹è¯•

### æ•°æ®åº“æ“ä½œæµ‹è¯•
```sql
-- æµ‹è¯•åŸºæœ¬æ›´æ–°
UPDATE course_sections SET "order" = 100 WHERE id = 'xxx';

-- æµ‹è¯•æ‰¹é‡æ’åº
UPDATE course_sections SET "order" = 1001 WHERE id = 'xxx1';
UPDATE course_sections SET "order" = 1 WHERE id = 'xxx1';
```

### åŠŸèƒ½éªŒè¯æ¸…å•
- [x] æ‹–æ‹½æ’åºä¿å­˜
- [x] ä¸Šç§»æŒ‰é’®ä¿å­˜
- [x] ä¸‹ç§»æŒ‰é’®ä¿å­˜  
- [x] ç¼–è¾‘ç« èŠ‚orderä¿å­˜
- [x] æ–°å¢è¯¾ç¨‹ç« èŠ‚orderä¿å­˜

## ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

### ä¸»è¦ä¿®æ”¹ï¼š`src/pages/admin/CourseManagement.tsx`

1. **handleDragEndå‡½æ•°** - ä¿®å¤æ‹–æ‹½æ’åºçš„orderå­—æ®µæ›´æ–°
2. **moveSectionUpå‡½æ•°** - ä¿®å¤ä¸Šç§»æ“ä½œçš„orderå­—æ®µæ›´æ–°
3. **moveSectionDownå‡½æ•°** - ä¿®å¤ä¸‹ç§»æ“ä½œçš„orderå­—æ®µæ›´æ–°
4. **handleSectionSubmitå‡½æ•°** - ä¿®å¤ç« èŠ‚ç¼–è¾‘çš„orderå­—æ®µæ’å…¥å’Œæ›´æ–°
5. **handleSubmitå‡½æ•°** - ä¿®å¤æ–°å¢è¯¾ç¨‹çš„ç« èŠ‚orderå­—æ®µæ’å…¥
6. **reorderSectionså‡½æ•°** - ä¿®å¤è¾…åŠ©æ’åºå‡½æ•°çš„orderå­—æ®µæ›´æ–°
7. **fetchCourseså‡½æ•°** - ä¿®å¤æŸ¥è¯¢è¯­å¥ä¸­çš„orderæ’åº
8. **fetchSectionså‡½æ•°** - ä¿®å¤æŸ¥è¯¢è¯­å¥ä¸­çš„orderæ’åº

### å…¶ä»–ä¿®æ”¹ï¼š`src/pages/CourseStudyPage.tsx`
- ä¿®å¤ç« èŠ‚æŸ¥è¯¢ä¸­çš„orderæ’åºè¯­å¥

## è°ƒè¯•åŠŸèƒ½

### æ·»åŠ è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—

ä¸ºäº†å¸®åŠ©æ’æŸ¥é—®é¢˜ï¼Œæ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼š

**1. æ‹–æ‹½æ’åºæ—¥å¿—ï¼š**
```typescript
console.log('ğŸš€ handleDragEnd called:', { result, courseId, sections: sections.length });
console.log('âœ… Valid drag operation:', { from: source.index, to: destination.index });
console.log('ğŸ’¾ Starting database update...');
console.log('ğŸ“ Step 1: Setting temporary order values');
console.log('ğŸ“ Step 2: Setting final order values');
```

**2. æŒ‰é’®æ’åºæ—¥å¿—ï¼š**
```typescript
console.log('â¬†ï¸ moveSectionUp called:', { courseId, sectionIndex });
console.log('â¬‡ï¸ moveSectionDown called:', { courseId, sectionIndex });
```

**3. æ•°æ®åº“æ“ä½œæ—¥å¿—ï¼š**
- æ˜¾ç¤ºæ¯ä¸ªç« èŠ‚çš„orderæ›´æ–°æ“ä½œ
- æ˜¾ç¤ºæ•°æ®åº“æ“ä½œçš„ç»“æœ
- é”™è¯¯ä¿¡æ¯çš„è¯¦ç»†è¾“å‡º

### ä½¿ç”¨æ–¹æ³•

1. æ‰“å¼€æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ°Consoleæ ‡ç­¾é¡µ
3. è¿›è¡Œç« èŠ‚æ’åºæ“ä½œ
4. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼Œäº†è§£æ“ä½œçš„å…·ä½“æ‰§è¡Œæƒ…å†µ

### æµ‹è¯•æ–‡ä»¶

åˆ›å»ºäº†ç‹¬ç«‹çš„æµ‹è¯•æ–‡ä»¶ `test-order-save.html` ç”¨äºéªŒè¯Supabaseçš„orderå­—æ®µæ›´æ–°æ“ä½œã€‚

## ç»“è®º

é€šè¿‡æ­£ç¡®å¤„ç†PostgreSQLä¿ç•™å­—`order`ï¼Œæ‰€æœ‰ç« èŠ‚æ’åºæ“ä½œç°åœ¨éƒ½èƒ½æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚è¿™ä¸ªä¿®å¤ç¡®ä¿äº†ï¼š

1. **æ•°æ®ä¸€è‡´æ€§**ï¼šå‰ç«¯æ˜¾ç¤ºçš„æ’åºä¸æ•°æ®åº“ä¸­çš„å®é™…æ’åºä¸€è‡´
2. **æ“ä½œå¯é æ€§**ï¼šæ‰€æœ‰æ’åºæ“ä½œéƒ½èƒ½æˆåŠŸä¿å­˜
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæ’åºæ“ä½œç«‹å³ç”Ÿæ•ˆä¸”æŒä¹…ä¿å­˜
4. **ç³»ç»Ÿç¨³å®šæ€§**ï¼šé¿å…äº†å› ä¿ç•™å­—å†²çªå¯¼è‡´çš„é™é»˜å¤±è´¥
5. **å¯è°ƒè¯•æ€§**ï¼šè¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜

ä¿®å¤å®Œæˆåï¼Œç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨æ‹–æ‹½æ’åºã€æŒ‰é’®æ’åºç­‰æ‰€æœ‰ç« èŠ‚æ’åºåŠŸèƒ½ã€‚ 