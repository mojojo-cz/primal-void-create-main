name: ç™»å½•åŠŸèƒ½å¥åº·æ£€æŸ¥

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆUTCæ—¶é—´å‰ä¸€å¤©18ç‚¹ï¼‰
    - cron: '0 18 * * *'  # UTCæ—¶é—´
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      test_account:
        description: 'æµ‹è¯•è´¦å·ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨Secretsä¸­çš„è´¦å·ï¼‰'
        required: false
        type: string
      test_password:
        description: 'æµ‹è¯•å¯†ç ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨Secretsä¸­çš„å¯†ç ï¼‰'
        required: false
        type: string

jobs:
  login-health-check:
    runs-on: ubuntu-latest
    name: ç™»å½•åŠŸèƒ½å¥åº·æ£€æŸ¥
    timeout-minutes: 10
    
    steps:
      - name: æ£€æŸ¥è¾“å…¥å‚æ•°
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œç™»å½•åŠŸèƒ½å¥åº·æ£€æŸ¥"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "æ‰§è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

      - name: æ‰§è¡Œç™»å½•å¥åº·æ£€æŸ¥
        id: login_check
        run: |
          echo "ğŸ” å¼€å§‹ç™»å½•åŠŸèƒ½æµ‹è¯•..."
          
          # è®¾ç½®æµ‹è¯•è´¦å·å’Œå¯†ç 
          TEST_ACCOUNT="${{ github.event.inputs.test_account || secrets.TEST_ACCOUNT }}"
          TEST_PASSWORD="${{ github.event.inputs.test_password || secrets.TEST_PASSWORD }}"
          
          if [ -z "$TEST_ACCOUNT" ] || [ -z "$TEST_PASSWORD" ]; then
            echo "âŒ æµ‹è¯•è´¦å·æˆ–å¯†ç æœªé…ç½®"
            echo "è¯·åœ¨GitHubä»“åº“è®¾ç½®ä¸­æ·»åŠ ä»¥ä¸‹Secrets:"
            echo "- TEST_ACCOUNT: æµ‹è¯•è´¦å·ï¼ˆç”¨æˆ·å/æ‰‹æœºå·/é‚®ç®±ï¼‰"
            echo "- TEST_PASSWORD: æµ‹è¯•å¯†ç "
            exit 1
          fi
          
          echo "ğŸ“§ æµ‹è¯•è´¦å·: ${TEST_ACCOUNT:0:3}***${TEST_ACCOUNT: -3}"
          
          # æ„å»ºç™»å½•è¯·æ±‚æ•°æ®
          LOGIN_DATA=$(cat << EOF
          {
            "account": "$TEST_ACCOUNT",
            "password": "$TEST_PASSWORD"
          }
          EOF
          )
          
          # æ‰§è¡Œç™»å½•æµ‹è¯•
          echo "ğŸŒ æ­£åœ¨æµ‹è¯•ç™»å½•API..."
          
          # ç¬¬ä¸€æ­¥ï¼šè·å–Supabaseä¼šè¯
          SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
          
          # åˆ¤æ–­è´¦å·ç±»å‹å¹¶è½¬æ¢ä¸ºç™»å½•é‚®ç®±
          if [[ "$TEST_ACCOUNT" =~ ^1[3-9][0-9]{9}$ ]]; then
            # æ‰‹æœºå·è½¬æ¢ä¸ºè™šæ‹Ÿé‚®ç®±
            LOGIN_EMAIL="${TEST_ACCOUNT}@phone.auth"
            ACCOUNT_TYPE="phone"
            echo "ğŸ“± æ£€æµ‹åˆ°æ‰‹æœºå·ï¼Œè½¬æ¢ä¸ºè™šæ‹Ÿé‚®ç®±: ${LOGIN_EMAIL}"
          elif [[ "$TEST_ACCOUNT" =~ ^[a-zA-Z0-9_]{3,50}$ ]]; then
            # ç”¨æˆ·åéœ€è¦æŸ¥è¯¢æ•°æ®åº“
            echo "ğŸ‘¤ æ£€æµ‹åˆ°ç”¨æˆ·åï¼Œéœ€è¦æŸ¥è¯¢å¯¹åº”é‚®ç®±..."
            
            # è°ƒç”¨æ•°æ®åº“å‡½æ•°æŸ¥è¯¢ç”¨æˆ·åå¯¹åº”çš„é‚®ç®±
            USERNAME_QUERY_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
              -X POST "$SUPABASE_URL/rest/v1/rpc/get_login_email_by_username" \
              -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
              -H "Content-Type: application/json" \
              -H "apikey: $SUPABASE_ANON_KEY" \
              -d "{\"username_input\": \"$TEST_ACCOUNT\"}")
              
            HTTP_CODE=$(echo "$USERNAME_QUERY_RESPONSE" | tail -n1 | cut -d':' -f2)
            RESPONSE_BODY=$(echo "$USERNAME_QUERY_RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "âŒ æŸ¥è¯¢ç”¨æˆ·åå¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $HTTP_CODE"
              echo "å“åº”å†…å®¹: $RESPONSE_BODY"
              exit 1
            fi
            
            LOGIN_EMAIL=$(echo "$RESPONSE_BODY" | jq -r '.')
            if [ "$LOGIN_EMAIL" = "null" ] || [ -z "$LOGIN_EMAIL" ]; then
              echo "âŒ ç”¨æˆ·åä¸å­˜åœ¨: $TEST_ACCOUNT"
              exit 1
            fi
            
            ACCOUNT_TYPE="username"
            echo "ğŸ” æŸ¥è¯¢åˆ°ç”¨æˆ·åå¯¹åº”é‚®ç®±: ${LOGIN_EMAIL:0:5}***@***"
          elif [[ "$TEST_ACCOUNT" =~ ^[^@]+@[^@]+\.[^@]+$ ]]; then
            # é‚®ç®±ç›´æ¥ä½¿ç”¨
            LOGIN_EMAIL="$TEST_ACCOUNT"
            ACCOUNT_TYPE="email"
            echo "ğŸ“§ æ£€æµ‹åˆ°é‚®ç®±ï¼Œç›´æ¥ä½¿ç”¨: ${LOGIN_EMAIL:0:5}***@***"
          else
            echo "âŒ æ— æ•ˆçš„è´¦å·æ ¼å¼: $TEST_ACCOUNT"
            echo "æ”¯æŒçš„æ ¼å¼: ç”¨æˆ·å(3-50å­—ç¬¦)ã€æ‰‹æœºå·(11ä½)ã€é‚®ç®±åœ°å€"
            exit 1
          fi
          
          # æ‰§è¡ŒSupabaseç™»å½•
          echo "ğŸ”‘ æ­£åœ¨æ‰§è¡Œç™»å½•..."
          LOGIN_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X POST "$SUPABASE_URL/auth/v1/token?grant_type=password" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "Content-Type: application/json" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -d "{
              \"email\": \"$LOGIN_EMAIL\",
              \"password\": \"$TEST_PASSWORD\"
            }")
          
          # æå–HTTPçŠ¶æ€ç å’Œå“åº”ä½“
          HTTP_CODE=$(echo "$LOGIN_RESPONSE" | tail -n1 | cut -d':' -f2)
          RESPONSE_BODY=$(echo "$LOGIN_RESPONSE" | sed '$d')
          
          echo "HTTPçŠ¶æ€ç : $HTTP_CODE"
          
          # æ£€æŸ¥ç™»å½•ç»“æœ
          if [ "$HTTP_CODE" = "200" ]; then
            # è§£æç™»å½•æˆåŠŸå“åº”
            ACCESS_TOKEN=$(echo "$RESPONSE_BODY" | jq -r '.access_token // empty')
            USER_ID=$(echo "$RESPONSE_BODY" | jq -r '.user.id // empty')
            USER_EMAIL=$(echo "$RESPONSE_BODY" | jq -r '.user.email // empty')
            
            if [ -n "$ACCESS_TOKEN" ] && [ -n "$USER_ID" ]; then
              echo "âœ… ç™»å½•æˆåŠŸ!"
              echo "ç”¨æˆ·ID: $USER_ID"
              echo "ç™»å½•é‚®ç®±: ${USER_EMAIL:0:5}***@***"
              echo "ä»¤ç‰Œé•¿åº¦: ${#ACCESS_TOKEN} å­—ç¬¦"
              
              # éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§ - è·å–ç”¨æˆ·èµ„æ–™
              echo "ğŸ” éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§..."
              PROFILE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
                -X POST "$SUPABASE_URL/rest/v1/rpc/get_user_profile_for_login" \
                -H "Authorization: Bearer $ACCESS_TOKEN" \
                -H "Content-Type: application/json" \
                -H "apikey: $SUPABASE_ANON_KEY" \
                -d "{\"user_id\": \"$USER_ID\"}")
              
              PROFILE_HTTP_CODE=$(echo "$PROFILE_RESPONSE" | tail -n1 | cut -d':' -f2)
              PROFILE_BODY=$(echo "$PROFILE_RESPONSE" | sed '$d')
              
              if [ "$PROFILE_HTTP_CODE" = "200" ]; then
                USER_TYPE=$(echo "$PROFILE_BODY" | jq -r '.[0].user_type // "unknown"')
                FULL_NAME=$(echo "$PROFILE_BODY" | jq -r '.[0].full_name // "æœªçŸ¥"')
                
                echo "âœ… ä»¤ç‰ŒéªŒè¯æˆåŠŸ!"
                echo "ç”¨æˆ·ç±»å‹: $USER_TYPE"
                echo "ç”¨æˆ·å§“å: $FULL_NAME"
                
                # è®¾ç½®æˆåŠŸç»“æœ
                echo "login_success=true" >> $GITHUB_OUTPUT
                echo "account_type=$ACCOUNT_TYPE" >> $GITHUB_OUTPUT
                echo "user_type=$USER_TYPE" >> $GITHUB_OUTPUT
                echo "user_name=$FULL_NAME" >> $GITHUB_OUTPUT
                echo "user_id=$USER_ID" >> $GITHUB_OUTPUT
              else
                echo "âš ï¸ ç™»å½•æˆåŠŸä½†ä»¤ç‰ŒéªŒè¯å¤±è´¥"
                echo "Profile APIå“åº”ç : $PROFILE_HTTP_CODE"
                echo "Profile APIå“åº”: $PROFILE_BODY"
                echo "login_success=partial" >> $GITHUB_OUTPUT
                echo "error_message=ä»¤ç‰ŒéªŒè¯å¤±è´¥" >> $GITHUB_OUTPUT
              fi
              
            else
              echo "âŒ ç™»å½•å“åº”æ ¼å¼å¼‚å¸¸"
              echo "å“åº”å†…å®¹: $RESPONSE_BODY"
              echo "login_success=false" >> $GITHUB_OUTPUT
              echo "error_message=ç™»å½•å“åº”æ ¼å¼å¼‚å¸¸" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            # ç™»å½•å¤±è´¥
            ERROR_MSG=$(echo "$RESPONSE_BODY" | jq -r '.error_description // .message // .error // "æœªçŸ¥é”™è¯¯"')
            echo "âŒ ç™»å½•å¤±è´¥!"
            echo "HTTPçŠ¶æ€ç : $HTTP_CODE"
            echo "é”™è¯¯ä¿¡æ¯: $ERROR_MSG"
            echo "å®Œæ•´å“åº”: $RESPONSE_BODY"
            
            echo "login_success=false" >> $GITHUB_OUTPUT
            echo "error_message=$ERROR_MSG" >> $GITHUB_OUTPUT
            echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ç”Ÿæˆå¥åº·æ£€æŸ¥æŠ¥å‘Š
        if: always()
        run: |
          echo "## ğŸ“‹ ç™»å½•åŠŸèƒ½å¥åº·æ£€æŸ¥æŠ¥å‘Š" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ£€æŸ¥æ—¶é—´**: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.login_check.outcome }}" = "success" ]; then
            if [ "${{ steps.login_check.outputs.login_success }}" = "true" ]; then
              echo "### âœ… ç™»å½•åŠŸèƒ½æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| æ£€æŸ¥é¡¹ | ç»“æœ |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
              echo "| è´¦å·ç±»å‹ | ${{ steps.login_check.outputs.account_type }} |" >> $GITHUB_STEP_SUMMARY
              echo "| ç”¨æˆ·ç±»å‹ | ${{ steps.login_check.outputs.user_type }} |" >> $GITHUB_STEP_SUMMARY
              echo "| ç”¨æˆ·å§“å | ${{ steps.login_check.outputs.user_name }} |" >> $GITHUB_STEP_SUMMARY
              echo "| ç™»å½•çŠ¶æ€ | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
              echo "| ä»¤ç‰ŒéªŒè¯ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.login_check.outputs.login_success }}" = "partial" ]; then
              echo "### âš ï¸ ç™»å½•åŠŸèƒ½éƒ¨åˆ†å¼‚å¸¸" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**é—®é¢˜**: ${{ steps.login_check.outputs.error_message }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ç™»å½•æˆåŠŸä½†åç»­éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·èµ„æ–™æŸ¥è¯¢åŠŸèƒ½ã€‚" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ ç™»å½•åŠŸèƒ½å¼‚å¸¸" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**é”™è¯¯ä¿¡æ¯**: ${{ steps.login_check.outputs.error_message }}" >> $GITHUB_STEP_SUMMARY
              echo "**HTTPçŠ¶æ€ç **: ${{ steps.login_check.outputs.http_code }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ å¥åº·æ£€æŸ¥æ‰§è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥æ‰§è¡Œæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ä¸‹æ¬¡è‡ªåŠ¨æ£€æŸ¥æ—¶é—´: $(TZ='Asia/Shanghai' date -d '+1 day' '+%Y-%m-%d 02:00:00') (åŒ—äº¬æ—¶é—´)*" >> $GITHUB_STEP_SUMMARY

      - name: ç™»å½•æˆåŠŸé€šçŸ¥
        if: success() && steps.login_check.outputs.login_success == 'true'
        run: |
          echo "ğŸ‰ ç™»å½•åŠŸèƒ½å¥åº·æ£€æŸ¥é€šè¿‡"
          echo "æµ‹è¯•è´¦å·ç±»å‹: ${{ steps.login_check.outputs.account_type }}"
          echo "ç”¨æˆ·ç±»å‹: ${{ steps.login_check.outputs.user_type }}"
          echo "ç”¨æˆ·å§“å: ${{ steps.login_check.outputs.user_name }}"
          echo "ç™»å½•ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œç”¨æˆ·å¯ä»¥æ­£å¸¸è®¿é—®"

      - name: ç™»å½•å¼‚å¸¸é€šçŸ¥
        if: failure() || steps.login_check.outputs.login_success != 'true'
        run: |
          echo "ğŸš¨ ç™»å½•åŠŸèƒ½å¼‚å¸¸è­¦å‘Š"
          echo "è¿™å¯èƒ½å¯¼è‡´ç”¨æˆ·æ— æ³•æ­£å¸¸ç™»å½•ç³»ç»Ÿ"
          echo ""
          echo "è¯·ç«‹å³æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› :"
          echo "1. æµ‹è¯•è´¦å·å¯†ç æ˜¯å¦æ­£ç¡®"
          echo "2. Supabaseè®¤è¯æœåŠ¡çŠ¶æ€"
          echo "3. æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸"
          echo "4. ç”¨æˆ·èµ„æ–™æŸ¥è¯¢åŠŸèƒ½æ˜¯å¦æ­£å¸¸"
          echo "5. ç½‘ç»œè¿æ¥é—®é¢˜"
          echo ""
          echo "ç´§æ€¥å¤„ç†æ–¹æ¡ˆ:"
          echo "1. æ£€æŸ¥Supabaseæ§åˆ¶å°è®¤è¯æ—¥å¿—"
          echo "2. éªŒè¯æµ‹è¯•è´¦å·åœ¨æ•°æ®åº“ä¸­çš„çŠ¶æ€"
          echo "3. æ‰‹åŠ¨åœ¨ç½‘ç«™ä¸Šæµ‹è¯•ç™»å½•åŠŸèƒ½"
          echo "4. é‡æ–°è¿è¡Œæ­¤å¥åº·æ£€æŸ¥"
          
          # å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šé€šçŸ¥æ–¹å¼
          # æ¯”å¦‚å‘é€é‚®ä»¶ã€Slackæ¶ˆæ¯ã€ä¼ä¸šå¾®ä¿¡ç­‰

      - name: æ¸…ç†å’Œæ€»ç»“
        if: always()
        run: |
          echo "ğŸ ç™»å½•å¥åº·æ£€æŸ¥å®Œæˆ"
          echo "æ£€æŸ¥ç»“æœ: ${{ steps.login_check.outputs.login_success || 'å¤±è´¥' }}"
          echo "ä¸‹æ¬¡è‡ªåŠ¨æ£€æŸ¥: $(TZ='Asia/Shanghai' date -d '+1 day' '+%Y-%m-%d 02:00:00') (åŒ—äº¬æ—¶é—´)"
          echo ""
          echo "ğŸ’¡ æç¤º:"
          echo "- å¯ä»¥åœ¨Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘æ£€æŸ¥"
          echo "- å¦‚éœ€ä¿®æ”¹æµ‹è¯•è´¦å·ï¼Œè¯·æ›´æ–°Repository Secrets"
          echo "- å»ºè®®å®šæœŸæ£€æŸ¥æµ‹è¯•è´¦å·çš„æœ‰æ•ˆæ€§" 