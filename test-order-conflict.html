<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orderå†²çªæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .test-section { border: 1px solid #ddd; margin: 15px 0; padding: 15px; border-radius: 6px; }
        .log { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 15px; margin: 15px 0; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .log-entry { margin: 3px 0; }
        .log-error { color: #dc3545; font-weight: bold; }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-info { color: #17a2b8; }
        .section-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; }
        .section-card { border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f9f9f9; }
        .section-card.highlight { background: #e3f2fd; border-color: #2196f3; }
        .btn { padding: 8px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: black; }
        .scenario { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Orderå”¯ä¸€çº¦æŸå†²çªæµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>æµ‹è¯•åœºæ™¯</h2>
            <div class="scenario">
                <strong>å†²çªåœºæ™¯ï¼š</strong>å°†order=8çš„ç« èŠ‚æ‹–æ‹½åˆ°ç¬¬1ä½ç½®<br>
                <strong>é—®é¢˜ï¼š</strong>ç›´æ¥è®¾ç½®order=1ä¼šä¸ç°æœ‰ç« èŠ‚å†²çª<br>
                <strong>è§£å†³æ–¹æ¡ˆï¼š</strong>ä¸¤é˜¶æ®µæ›´æ–° - å…ˆè®¾ä¸´æ—¶å€¼ï¼Œå†è®¾æœ€ç»ˆå€¼
            </div>
            
            <button class="btn" onclick="testOrderConflict()">æµ‹è¯•Orderå†²çªåœºæ™¯</button>
            <button class="btn btn-warning" onclick="testTempOrderGeneration()">æµ‹è¯•ä¸´æ—¶Orderç”Ÿæˆ</button>
            <button class="btn btn-success" onclick="testTwoPhaseUpdate()">æµ‹è¯•ä¸¤é˜¶æ®µæ›´æ–°</button>
            <button class="btn btn-danger" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="test-section">
            <h2>å½“å‰ç« èŠ‚çŠ¶æ€</h2>
            <div id="sectionsDisplay" class="section-grid">
                <!-- ç« èŠ‚çŠ¶æ€æ˜¾ç¤º -->
            </div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•æ—¥å¿—</h2>
            <div id="testLog" class="log">
                <div class="log-entry">ğŸ“‹ Orderå†²çªæµ‹è¯• - æ¨¡æ‹ŸçœŸå®æ‹–æ‹½åœºæ™¯</div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿè¯¾ç¨‹ç« èŠ‚æ•°æ®
        let sections = [
            { id: 'section-1', title: 'ç¬¬1ç« ï¼šé¡¹ç›®ä»‹ç»', order: 1 },
            { id: 'section-2', title: 'ç¬¬2ç« ï¼šç¯å¢ƒæ­å»º', order: 2 },
            { id: 'section-3', title: 'ç¬¬3ç« ï¼šåŸºç¡€è¯­æ³•', order: 3 },
            { id: 'section-4', title: 'ç¬¬4ç« ï¼šæ•°æ®ç±»å‹', order: 4 },
            { id: 'section-5', title: 'ç¬¬5ç« ï¼šæ§åˆ¶æµ', order: 5 },
            { id: 'section-6', title: 'ç¬¬6ç« ï¼šå‡½æ•°å®šä¹‰', order: 6 },
            { id: 'section-7', title: 'ç¬¬7ç« ï¼šé¢å‘å¯¹è±¡', order: 7 },
            { id: 'section-8', title: 'ç¬¬8ç« ï¼šé«˜çº§ç‰¹æ€§', order: 8 },
            { id: 'section-9', title: 'ç¬¬9ç« ï¼šé¡¹ç›®å®æˆ˜', order: 9 },
            { id: 'section-10', title: 'ç¬¬10ç« ï¼šéƒ¨ç½²å‘å¸ƒ', order: 10 }
        ];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '<div class="log-entry">ğŸ“‹ æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        function renderSections(highlightIds = []) {
            const container = document.getElementById('sectionsDisplay');
            container.innerHTML = '';
            
            sections.forEach(section => {
                const div = document.createElement('div');
                div.className = `section-card ${highlightIds.includes(section.id) ? 'highlight' : ''}`;
                div.innerHTML = `
                    <strong>${section.title}</strong><br>
                    Order: ${section.order}
                `;
                container.appendChild(div);
            });
        }

        function testOrderConflict() {
            log('ğŸš€ å¼€å§‹æµ‹è¯•Orderå†²çªåœºæ™¯', 'info');
            log('ğŸ“‹ åœºæ™¯ï¼šå°†ç¬¬8ç« æ‹–æ‹½åˆ°ç¬¬1ä½ç½®', 'info');
            
            // æ‰¾åˆ°è¦ç§»åŠ¨çš„ç« èŠ‚
            const sourceSection = sections.find(s => s.order === 8);
            const targetSection = sections.find(s => s.order === 1);
            
            log(`ğŸ“ æºç« èŠ‚: ${sourceSection.title} (order=${sourceSection.order})`, 'info');
            log(`ğŸ“ ç›®æ ‡ä½ç½®: ç¬¬1ä½ (å½“å‰è¢« "${targetSection.title}" å ç”¨)`, 'info');
            
            // æ¸²æŸ“å¹¶é«˜äº®ç›¸å…³ç« èŠ‚
            renderSections([sourceSection.id, targetSection.id]);
            
            // æ¨¡æ‹Ÿç›´æ¥æ›´æ–°å†²çª
            log('âŒ å°è¯•ç›´æ¥è®¾ç½® order=1...', 'error');
            log('âŒ æ•°æ®åº“é”™è¯¯: è¿åå”¯ä¸€çº¦æŸ (course_id, order)', 'error');
            log('âŒ DETAIL: Key (course_id, order)=(course-123, 1) already exists', 'error');
            
            log('ğŸ”§ éœ€è¦ä½¿ç”¨ä¸¤é˜¶æ®µæ›´æ–°ç­–ç•¥é¿å…å†²çª', 'warning');
        }

        function testTempOrderGeneration() {
            log('ğŸ”§ æµ‹è¯•ä¸´æ—¶Orderç”Ÿæˆç­–ç•¥', 'info');
            
            // è·å–å½“å‰æœ€å¤§orderå€¼
            const currentMaxOrder = Math.max(...sections.map(s => s.order || 0));
            log(`ğŸ“Š å½“å‰æœ€å¤§Orderå€¼: ${currentMaxOrder}`, 'info');
            
            // æµ‹è¯•ä¸åŒçš„ä¸´æ—¶orderç”Ÿæˆæ–¹æ³•
            const methods = [
                { name: 'å›ºå®šå€¼æ³•', value: 10000 },
                { name: 'åŸºäºæœ€å¤§å€¼æ³•', value: currentMaxOrder + 1000 },
                { name: 'å®‰å…¨è¾¹ç•Œæ³•', value: Math.max(10000, currentMaxOrder + 1000) }
            ];
            
            methods.forEach((method, index) => {
                log(`ğŸ§ª æ–¹æ³•${index + 1}: ${method.name} = ${method.value}`, 'info');
                
                // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰å€¼å†²çª
                const hasConflict = sections.some(s => s.order === method.value);
                if (hasConflict) {
                    log(`  âŒ å†²çªï¼ä¸ç°æœ‰ç« èŠ‚orderå€¼é‡å¤`, 'error');
                } else {
                    log(`  âœ… å®‰å…¨ï¼Œæ— å†²çª`, 'success');
                }
            });
            
            // æ¨èçš„ä¸´æ—¶orderç”Ÿæˆ
            const recommendedBase = Math.max(10000, currentMaxOrder + 1000);
            log(`ğŸ’¡ æ¨èä¸´æ—¶OrderåŸºç¡€å€¼: ${recommendedBase}`, 'success');
            
            // ä¸ºæ‰€æœ‰ç« èŠ‚ç”Ÿæˆä¸´æ—¶order
            sections.forEach((section, index) => {
                const tempOrder = recommendedBase + index + 1;
                log(`  ${section.title}: ä¸´æ—¶order = ${tempOrder}`, 'info');
            });
        }

        function testTwoPhaseUpdate() {
            log('ğŸ—„ï¸ æµ‹è¯•ä¸¤é˜¶æ®µæ›´æ–°æµç¨‹', 'info');
            log('ğŸ“‹ åœºæ™¯ï¼šå°†ç¬¬8ç« ç§»åŠ¨åˆ°ç¬¬1ä½ç½®', 'info');
            
            // æ¨¡æ‹Ÿæ‹–æ‹½é‡æ’åº
            const sourceIndex = sections.findIndex(s => s.order === 8);
            const targetIndex = 0; // ç§»åŠ¨åˆ°ç¬¬1ä½
            
            log(`ğŸ“ æºç´¢å¼•: ${sourceIndex}, ç›®æ ‡ç´¢å¼•: ${targetIndex}`, 'info');
            
            // æ‰§è¡Œæ•°ç»„é‡æ’åº
            const reorderedSections = Array.from(sections);
            const [removed] = reorderedSections.splice(sourceIndex, 1);
            reorderedSections.splice(targetIndex, 0, removed);
            
            log(`ğŸ“‹ é‡æ’åºå: ${reorderedSections.map(s => s.title.split('ï¼š')[0]).join(' â†’ ')}`, 'info');
            
            // ç¬¬ä¸€é˜¶æ®µï¼šè®¾ç½®ä¸´æ—¶order
            log('ğŸ“ ç¬¬ä¸€é˜¶æ®µï¼šè®¾ç½®ä¸´æ—¶orderå€¼', 'warning');
            const currentMaxOrder = Math.max(...sections.map(s => s.order || 0));
            const tempOrderBase = Math.max(10000, currentMaxOrder + 1000);
            
            reorderedSections.forEach((section, index) => {
                const tempOrder = tempOrderBase + index + 1;
                log(`  UPDATE ${section.title}: order = ${tempOrder}`, 'info');
            });
            
            // æ¨¡æ‹Ÿç¬¬ä¸€é˜¶æ®µå®Œæˆ
            setTimeout(() => {
                log('âœ… ç¬¬ä¸€é˜¶æ®µå®Œæˆï¼šæ‰€æœ‰ä¸´æ—¶orderè®¾ç½®æˆåŠŸ', 'success');
                
                // ç¬¬äºŒé˜¶æ®µï¼šè®¾ç½®æœ€ç»ˆorder
                log('ğŸ“ ç¬¬äºŒé˜¶æ®µï¼šè®¾ç½®æœ€ç»ˆorderå€¼', 'warning');
                reorderedSections.forEach((section, index) => {
                    const finalOrder = index + 1;
                    log(`  UPDATE ${section.title}: order = ${finalOrder}`, 'info');
                });
                
                setTimeout(() => {
                    log('âœ… ç¬¬äºŒé˜¶æ®µå®Œæˆï¼šæ‰€æœ‰æœ€ç»ˆorderè®¾ç½®æˆåŠŸ', 'success');
                    log('ğŸ‰ ä¸¤é˜¶æ®µæ›´æ–°å®Œæˆï¼ç« èŠ‚é¡ºåºå·²æ›´æ–°', 'success');
                    
                    // æ›´æ–°æœ¬åœ°æ•°æ®å¹¶é‡æ–°æ¸²æŸ“
                    sections = reorderedSections.map((section, index) => ({
                        ...section,
                        order: index + 1
                    }));
                    renderSections();
                    
                }, 1000);
            }, 1000);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderSections();
            log('ğŸ¯ Orderå†²çªæµ‹è¯•å·¥å…·å·²åŠ è½½', 'success');
            log('ğŸ’¡ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•ä¸åŒåœºæ™¯', 'info');
        });
    </script>
</body>
</html> 