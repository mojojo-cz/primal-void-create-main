<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶åæ¸…ç†æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .result {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        .test-case {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .original {
            font-weight: bold;
            color: #dc2626;
        }
        
        .cleaned {
            font-weight: bold;
            color: #059669;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§¹ æ–‡ä»¶åæ¸…ç†åŠŸèƒ½æµ‹è¯•</h1>
        <p>æµ‹è¯•S3æ–‡ä»¶åæ¸…ç†åŠŸèƒ½ï¼Œç¡®ä¿ç¬¦åˆAWS S3å‘½åè§„èŒƒ</p>
        
        <div style="margin-bottom: 30px;">
            <label for="testInput"><strong>è¾“å…¥æµ‹è¯•æ–‡ä»¶å:</strong></label>
            <input type="text" id="testInput" class="test-input" placeholder="ä¾‹å¦‚: new_å‰¯æœ¬ (1).mov" value="new_å‰¯æœ¬ (1).mov">
            <div id="result" class="result" style="display: none;"></div>
        </div>
        
        <h2>é¢„è®¾æµ‹è¯•ç”¨ä¾‹</h2>
        <div id="testCases"></div>
    </div>

    <script>
        // æ¸…ç†æ–‡ä»¶åå‡½æ•°ï¼ˆä¸ç»„ä»¶ä¸­ç›¸åŒçš„é€»è¾‘ï¼‰
        function sanitizeFileName(fileName) {
            const nameWithoutExt = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
            const extension = fileName.substring(fileName.lastIndexOf('.')) || '';
            
            const cleanName = nameWithoutExt
                .replace(/[^\w\-_.]/g, '_') // æ›¿æ¢ç‰¹æ®Šå­—ç¬¦ä¸ºä¸‹åˆ’çº¿
                .replace(/_{2,}/g, '_') // åˆå¹¶å¤šä¸ªè¿ç»­ä¸‹åˆ’çº¿
                .replace(/^_|_$/g, '') // ç§»é™¤å¼€å¤´å’Œç»“å°¾çš„ä¸‹åˆ’çº¿
                .substring(0, 100); // é™åˆ¶é•¿åº¦
            
            return cleanName + extension;
        }
        
        // æµ‹è¯•ç”¨ä¾‹
        const testCases = [
            'new_å‰¯æœ¬ (1).mov',
            'video test file.mp4',
            'my-video_file.avi',
            'video@#$%^&*()file.mkv',
            'normal_video.mp4',
            'è§†é¢‘æ–‡ä»¶ - å‰¯æœ¬.wmv',
            'file   with   spaces.mp4',
            '___leading_trailing___.mp4',
            'very_very_very_long_filename_that_exceeds_the_normal_limits_and_should_be_truncated_properly_to_ensure_compatibility.mp4',
            'file.with.multiple.dots.mp4',
            'ç‰¹æ®Šå­—ç¬¦ï¼@#ï¿¥%â€¦â€¦&*ï¼ˆï¼‰.mov'
        ];
        
        // æ¸²æŸ“æµ‹è¯•ç”¨ä¾‹
        function renderTestCases() {
            const container = document.getElementById('testCases');
            container.innerHTML = testCases.map((testCase, index) => {
                const cleaned = sanitizeFileName(testCase);
                const timestamp = Date.now();
                const randomId = Math.random().toString(36).substr(2, 9);
                const finalName = `${timestamp}_${randomId}_${cleaned}`;
                
                return `
                    <div class="test-case">
                        <h3>æµ‹è¯•ç”¨ä¾‹ ${index + 1}</h3>
                        <p><strong>åŸå§‹æ–‡ä»¶å:</strong> <span class="original">${testCase}</span></p>
                        <p><strong>æ¸…ç†å:</strong> <span class="cleaned">${cleaned}</span></p>
                        <p><strong>æœ€ç»ˆæ–‡ä»¶å:</strong> <code>${finalName}</code></p>
                        <p><strong>é•¿åº¦:</strong> ${finalName.length} å­—ç¬¦</p>
                    </div>
                `;
            }).join('');
        }
        
        // å®æ—¶æµ‹è¯•
        function testInput() {
            const input = document.getElementById('testInput');
            const result = document.getElementById('result');
            
            input.addEventListener('input', function() {
                const original = this.value;
                if (!original) {
                    result.style.display = 'none';
                    return;
                }
                
                const cleaned = sanitizeFileName(original);
                const timestamp = Date.now();
                const randomId = Math.random().toString(36).substr(2, 9);
                const finalName = `${timestamp}_${randomId}_${cleaned}`;
                
                result.innerHTML = `
                    <p><strong>åŸå§‹:</strong> <span class="original">${original}</span></p>
                    <p><strong>æ¸…ç†å:</strong> <span class="cleaned">${cleaned}</span></p>
                    <p><strong>æœ€ç»ˆæ–‡ä»¶å:</strong> <code>${finalName}</code></p>
                    <p><strong>é•¿åº¦:</strong> ${finalName.length} å­—ç¬¦</p>
                    <p><strong>æ˜¯å¦ç¬¦åˆS3è§„èŒƒ:</strong> ${isValidS3Key(finalName) ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
                `;
                result.style.display = 'block';
            });
        }
        
        // éªŒè¯S3 Keyæ˜¯å¦ç¬¦åˆè§„èŒƒ
        function isValidS3Key(key) {
            // åŸºæœ¬è§„åˆ™æ£€æŸ¥
            if (key.length === 0 || key.length > 1024) return false;
            
            // ä¸èƒ½ä»¥æ–œæ å¼€å¤´
            if (key.startsWith('/')) return false;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸å®‰å…¨å­—ç¬¦
            const unsafeChars = /[^\w\-_.\/]/;
            return !unsafeChars.test(key);
        }
        
        // åˆå§‹åŒ–
        renderTestCases();
        testInput();
        
        // è§¦å‘åˆå§‹æµ‹è¯•
        document.getElementById('testInput').dispatchEvent(new Event('input'));
    </script>
</body>
</html> 