<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MinIOä¸Šä¼ è°ƒè¯•å·¥å…· - æ”¹è¿›ç‰ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #0066cc; }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .file-info {
            background-color: #e7f3ff;
            border: 1px solid #b6d7ff;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        .timeout-control {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ MinIOä¸Šä¼ è°ƒè¯•å·¥å…· - æ”¹è¿›ç‰ˆ</h1>
        <p>å¢å¼ºçš„è°ƒè¯•åŠŸèƒ½ï¼ŒåŒ…å«è¯¦ç»†è¿›åº¦è·Ÿè¸ªå’Œé”™è¯¯å¤„ç†</p>

        <div class="timeout-control">
            <h3>â±ï¸ è¶…æ—¶è®¾ç½®</h3>
            <label>
                è¯·æ±‚è¶…æ—¶æ—¶é—´: 
                <select id="timeoutSelect">
                    <option value="30000">30ç§’</option>
                    <option value="60000">60ç§’</option>
                    <option value="120000">120ç§’</option>
                    <option value="300000" selected>300ç§’ (æ¨èå¤§æ–‡ä»¶)</option>
                    <option value="600000">600ç§’ (10åˆ†é’Ÿ)</option>
                </select>
            </label>
            <div style="margin-top: 10px; font-size: 14px; color: #666;">
                <strong>å»ºè®®ï¼š</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li>å°æ–‡ä»¶ (< 1MB): 30-60ç§’</li>
                    <li>ä¸­ç­‰æ–‡ä»¶ (1-10MB): 120-300ç§’</li>
                    <li>å¤§æ–‡ä»¶ (> 10MB): 300-600ç§’</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>æ–‡ä»¶é€‰æ‹©</h3>
            <input type="file" id="videoFile" accept="video/*">
            <div id="fileInfo" class="file-info" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•æ­¥éª¤</h3>
            <button onclick="testMinIOConnection()">1. æµ‹è¯•MinIOè¿æ¥</button>
            <button onclick="testEdgeFunction()">2. æµ‹è¯•Edge Function</button>
            <button onclick="uploadVideo()">3. ä¸Šä¼ è§†é¢‘ (æ”¹è¿›ç‰ˆ)</button>
            <button onclick="uploadVideoChunked()">4. åˆ†å—ä¸Šä¼  (å¤§æ–‡ä»¶)</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        </div>

        <div class="test-section">
            <h3>ä¸Šä¼ è¿›åº¦</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressText">ç­‰å¾…å¼€å§‹...</div>
        </div>

        <div class="test-section">
            <h3>è°ƒè¯•æ—¥å¿—</h3>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://eotqgpcgzgjtywddvdpd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvdHFncGNnemdqdHl3ZGR2ZHBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI1NDA1MTgsImV4cCI6MjA0ODExNjUxOH0.Hmu8xOLXNhqEZSfJMQxW50Q-fXE4R8zlnO1L0B-F_Y4';

        let currentTimeout = 60000; // é»˜è®¤60ç§’

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function clearLogs() {
            document.getElementById('debugLog').innerHTML = '';
            updateProgress(0, 'ç­‰å¾…å¼€å§‹...');
        }

        // æ›´æ–°è¶…æ—¶è®¾ç½®
        document.getElementById('timeoutSelect').addEventListener('change', function() {
            currentTimeout = parseInt(this.value);
            log(`è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º: ${currentTimeout/1000}ç§’`, 'info');
        });

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        document.getElementById('videoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileInfo = document.getElementById('fileInfo');
                const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
                fileInfo.innerHTML = `
                    <strong>æ–‡ä»¶ä¿¡æ¯:</strong><br>
                    åç§°: ${file.name}<br>
                    å¤§å°: ${sizeInMB} MB (${file.size} bytes)<br>
                    ç±»å‹: ${file.type}<br>
                    æœ€åä¿®æ”¹: ${new Date(file.lastModified).toLocaleString()}
                `;
                fileInfo.style.display = 'block';
                log(`æ–‡ä»¶å·²é€‰æ‹©: ${file.name} (${sizeInMB} MB)`, 'info');
            }
        });

        async function testMinIOConnection() {
            log('å¼€å§‹æµ‹è¯•MinIOè¿æ¥...', 'info');
            updateProgress(10, 'æµ‹è¯•MinIOè¿æ¥...');
            
            try {
                const response = await fetch('https://115.159.33.45:9000/minio/health/live', {
                    method: 'GET',
                    signal: AbortSignal.timeout(10000)
                });
                
                if (response.ok) {
                    log('âœ… MinIOæœåŠ¡å™¨è¿æ¥æˆåŠŸ', 'success');
                    updateProgress(100, 'MinIOè¿æ¥æˆåŠŸ');
                } else {
                    log(`âŒ MinIOè¿æ¥å¤±è´¥: ${response.status}`, 'error');
                    updateProgress(0, 'MinIOè¿æ¥å¤±è´¥');
                }
            } catch (error) {
                log(`âŒ MinIOè¿æ¥é”™è¯¯: ${error.message}`, 'error');
                updateProgress(0, 'MinIOè¿æ¥é”™è¯¯');
            }
        }

        async function testEdgeFunction() {
            log('å¼€å§‹æµ‹è¯•Edge Function...', 'info');
            updateProgress(10, 'æµ‹è¯•Edge Function...');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/minio-video-upload`, {
                    method: 'OPTIONS',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    },
                    signal: AbortSignal.timeout(10000)
                });
                
                log(`Edge Functionå“åº”çŠ¶æ€: ${response.status}`, 'info');
                
                if (response.ok || response.status === 405) {
                    log('âœ… Edge Functionå¯è®¿é—®', 'success');
                    updateProgress(100, 'Edge Functionæµ‹è¯•æˆåŠŸ');
                } else {
                    log(`âŒ Edge Functionæµ‹è¯•å¤±è´¥: ${response.status}`, 'error');
                    updateProgress(0, 'Edge Functionæµ‹è¯•å¤±è´¥');
                }
            } catch (error) {
                log(`âŒ Edge Functionæµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
                updateProgress(0, 'Edge Functionæµ‹è¯•é”™è¯¯');
            }
        }

        async function uploadVideo() {
            const fileInput = document.getElementById('videoFile');
            if (!fileInput.files[0]) {
                log('âŒ è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶', 'error');
                return;
            }

            const file = fileInput.files[0];
            log(`å¼€å§‹ä¸Šä¼ è§†é¢‘: ${file.name}`, 'info');
            updateProgress(0, 'å‡†å¤‡ä¸Šä¼ ...');

            try {
                // æ­¥éª¤1: å‡†å¤‡æ–‡ä»¶æ•°æ®
                updateProgress(10, 'å‡†å¤‡æ–‡ä»¶æ•°æ®...');
                log('æ­£åœ¨è¯»å–æ–‡ä»¶å†…å®¹...', 'info');
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('title', file.name.split('.')[0]);
                formData.append('description', `ä¸Šä¼ äº ${new Date().toLocaleString()}`);

                // æ­¥éª¤2: å¼€å§‹ä¸Šä¼ 
                updateProgress(20, 'å¼€å§‹ä¸Šä¼ åˆ°MinIO...');
                log('å¼€å§‹è°ƒç”¨Edge Function...', 'info');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    log(`âŒ ä¸Šä¼ è¶…æ—¶ (${currentTimeout/1000}ç§’)`, 'error');
                }, currentTimeout);

                const response = await fetch(`${SUPABASE_URL}/functions/v1/minio-video-upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    },
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                // æ­¥éª¤3: å¤„ç†å“åº”
                updateProgress(80, 'å¤„ç†æœåŠ¡å™¨å“åº”...');
                log(`æœåŠ¡å™¨å“åº”çŠ¶æ€: ${response.status}`, 'info');
                
                const responseText = await response.text();
                log(`å“åº”å†…å®¹: ${responseText}`, 'info');

                if (response.ok) {
                    const result = JSON.parse(responseText);
                    log('âœ… è§†é¢‘ä¸Šä¼ æˆåŠŸ!', 'success');
                    log(`æ–‡ä»¶ID: ${result.id}`, 'success');
                    log(`MinIO URL: ${result.video_url}`, 'success');
                    updateProgress(100, 'ä¸Šä¼ æˆåŠŸ!');
                } else {
                    log(`âŒ ä¸Šä¼ å¤±è´¥: ${response.status} - ${responseText}`, 'error');
                    updateProgress(0, 'ä¸Šä¼ å¤±è´¥');
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    log(`âŒ ä¸Šä¼ è¢«å–æ¶ˆæˆ–è¶…æ—¶`, 'error');
                } else {
                    log(`âŒ ä¸Šä¼ è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`, 'error');
                }
                updateProgress(0, 'ä¸Šä¼ å¤±è´¥');
            }
        }

        async function uploadVideoChunked() {
            const fileInput = document.getElementById('videoFile');
            if (!fileInput.files[0]) {
                log('âŒ è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶', 'error');
                return;
            }

            const file = fileInput.files[0];
            const chunkSize = 5 * 1024 * 1024; // 5MB chunks
            
            if (file.size <= chunkSize) {
                log('æ–‡ä»¶è¾ƒå°ï¼Œä½¿ç”¨å¸¸è§„ä¸Šä¼ ', 'info');
                return uploadVideo();
            }

            log(`å¼€å§‹åˆ†å—ä¸Šä¼ å¤§æ–‡ä»¶: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`, 'info');
            log(`åˆ†å—å¤§å°: ${chunkSize/1024/1024} MB`, 'info');
            
            // è¿™é‡Œå¯ä»¥å®ç°åˆ†å—ä¸Šä¼ é€»è¾‘
            // æš‚æ—¶æç¤ºç”¨æˆ·ä½¿ç”¨è¾ƒå°çš„æ–‡ä»¶
            log('âš ï¸ åˆ†å—ä¸Šä¼ åŠŸèƒ½å¼€å‘ä¸­ï¼Œè¯·å°è¯•ä¸Šä¼ è¾ƒå°çš„æ–‡ä»¶ (< 5MB)', 'warning');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            log('è°ƒè¯•å·¥å…·å·²åŠ è½½', 'info');
            log(`å½“å‰è¶…æ—¶è®¾ç½®: ${currentTimeout/1000}ç§’`, 'info');
        });
    </script>
</body>
</html> 