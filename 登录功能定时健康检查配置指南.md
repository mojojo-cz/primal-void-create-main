# 登录功能定时健康检查配置指南

## 🎯 功能概述

自动执行登录功能健康检查，确保用户能够正常登录系统。每天北京时间凌晨2点自动执行，如果登录失败会及时发出警告。

## ⚙️ 配置步骤

### 1. 设置GitHub Secrets

在GitHub仓库中配置测试账号信息：

1. 进入GitHub仓库 → Settings → Secrets and variables → Actions
2. 点击 "New repository secret"
3. 添加以下两个密钥：

#### 必需的Secrets配置

| 密钥名称 | 说明 | 示例值 |
|----------|------|--------|
| `TEST_ACCOUNT` | 测试账号（支持用户名/手机号/邮箱） | `testuser` 或 `13812345678` 或 `test@example.com` |
| `TEST_PASSWORD` | 测试账号的密码 | `your_test_password` |

#### 配置示例

```
TEST_ACCOUNT = testuser
TEST_PASSWORD = 123456
```

**⚠️ 安全建议**：
- 建议创建专门的测试账号，不要使用真实用户账号
- 测试账号应具有基本的登录权限
- 定期更换测试账号密码

### 2. 验证账号格式

系统支持三种账号格式：

#### 用户名格式
- **规则**: 3-50个字符，只能包含字母、数字、下划线
- **示例**: `testuser`、`admin123`、`user_001`

#### 手机号格式  
- **规则**: 11位数字，以1开头，第二位是3-9
- **示例**: `13812345678`、`15987654321`

#### 邮箱格式
- **规则**: 标准邮箱格式
- **示例**: `test@example.com`、`admin@company.org`

## 🔄 执行机制

### 自动执行时间
- **频率**: 每天执行一次
- **时间**: 北京时间凌晨2:00（UTC时间前一天18:00）
- **cron表达式**: `0 18 * * *`

### 手动触发
除了自动执行，您还可以：

1. **GitHub Actions页面手动触发**:
   - 进入仓库 → Actions → "登录功能健康检查"
   - 点击 "Run workflow"
   - 可选择使用不同的测试账号

2. **临时账号测试**:
   - 在手动触发时可以输入临时测试账号
   - 临时账号优先级高于Secrets中的配置

## 🔍 检查流程

### 1. 账号类型识别
系统会自动识别输入的账号类型：

```mermaid
graph TD
    A[输入账号] --> B{检查格式}
    B -->|11位数字| C[手机号]
    B -->|3-50字符| D[用户名] 
    B -->|包含@符号| E[邮箱]
    C --> F[转换为虚拟邮箱]
    D --> G[查询数据库获取邮箱]
    E --> H[直接使用邮箱]
    F --> I[执行登录]
    G --> I
    H --> I
```

### 2. 登录验证流程
1. **账号转换**: 将输入账号转换为登录邮箱
2. **执行登录**: 调用Supabase认证API
3. **令牌验证**: 验证返回的访问令牌
4. **用户资料**: 获取用户基本信息
5. **结果报告**: 生成详细的检查报告

### 3. 检查项目

| 检查项 | 说明 |
|--------|------|
| 账号格式 | 验证账号格式是否正确 |
| 账号存在性 | 验证账号是否在系统中存在 |
| 密码正确性 | 验证密码是否正确 |
| 登录API | 验证Supabase认证服务 |
| 令牌有效性 | 验证返回的访问令牌 |
| 用户资料 | 验证用户资料查询功能 |

## 📋 结果报告

### 成功状态
```
✅ 登录功能正常

| 检查项 | 结果 |
|--------|------|
| 账号类型 | username |
| 用户类型 | student |
| 用户姓名 | 测试用户 |
| 登录状态 | ✅ 成功 |
| 令牌验证 | ✅ 通过 |
```

### 异常状态
```
❌ 登录功能异常

错误信息: Invalid login credentials
HTTP状态码: 400
```

### 部分异常
```
⚠️ 登录功能部分异常

问题: 令牌验证失败
登录成功但后续验证失败，请检查用户资料查询功能。
```

## 🚨 异常处理

### 常见错误及解决方案

#### 1. 账号或密码错误
**错误信息**: `Invalid login credentials`
**解决方案**:
- 检查TEST_ACCOUNT和TEST_PASSWORD是否正确
- 确认测试账号在系统中存在且密码正确
- 检查账号是否被禁用或过期

#### 2. 用户名不存在
**错误信息**: `用户名不存在: testuser`
**解决方案**:
- 确认输入的用户名确实存在于数据库中
- 检查用户名是否有大小写错误
- 考虑使用手机号或邮箱进行测试

#### 3. 数据库查询失败
**错误信息**: `查询用户名失败，HTTP状态码: 500`
**解决方案**:
- 检查数据库函数`get_login_email_by_username`是否正常
- 验证Supabase数据库连接状态
- 检查RPC权限配置

#### 4. 令牌验证失败
**错误信息**: `令牌验证失败`
**解决方案**:
- 检查数据库函数`get_user_profile_for_login`是否正常
- 验证RLS策略配置
- 检查用户资料表的数据完整性

### 监控建议

1. **定期检查日志**: 查看GitHub Actions执行日志
2. **关注失败通知**: 及时处理登录异常警告
3. **测试账号维护**: 定期验证测试账号的有效性
4. **系统状态监控**: 结合其他监控工具综合判断

## 🔧 高级配置

### 自定义检查频率

如需修改检查频率，编辑`.github/workflows/login-health-check.yml`文件中的cron表达式：

```yaml
on:
  schedule:
    # 每12小时执行一次
    - cron: '0 6,18 * * *'
    # 每小时执行一次  
    - cron: '0 * * * *'
    # 仅工作日执行
    - cron: '0 18 * * 1-5'
```

### 添加通知功能

可以在异常处理步骤中添加更多通知方式：

```yaml
- name: 发送邮件通知
  if: failure()
  uses: dawidd6/action-send-mail@v3
  with:
    server_address: smtp.gmail.com
    server_port: 587
    username: ${{ secrets.MAIL_USERNAME }}
    password: ${{ secrets.MAIL_PASSWORD }}
    subject: 登录功能异常警告
    body: 系统登录功能检测到异常，请立即检查。
```

### 多账号测试

可以扩展配置支持多个测试账号：

```yaml
strategy:
  matrix:
    account: 
      - ${{ secrets.TEST_ACCOUNT_1 }}
      - ${{ secrets.TEST_ACCOUNT_2 }}
    include:
      - account: ${{ secrets.TEST_ACCOUNT_1 }}
        password: ${{ secrets.TEST_PASSWORD_1 }}
      - account: ${{ secrets.TEST_ACCOUNT_2 }}
        password: ${{ secrets.TEST_PASSWORD_2 }}
```

## 📊 使用统计

通过GitHub Actions的执行历史，您可以获得：

- **成功率统计**: 登录功能的稳定性趋势
- **响应时间**: 登录API的性能表现
- **失败模式**: 常见错误类型分析
- **可用性报告**: 系统整体健康状况

## 🎯 最佳实践

1. **测试账号管理**:
   - 使用专门的测试账号，不影响真实用户
   - 确保测试账号权限最小化
   - 定期轮换测试账号密码

2. **监控策略**:
   - 设置合理的检查频率，避免过于频繁
   - 关注持续失败的警告信号
   - 建立故障响应流程

3. **安全考虑**:
   - 不在代码中硬编码敏感信息
   - 使用GitHub Secrets管理凭据
   - 定期审核访问权限

4. **维护建议**:
   - 定期检查工作流执行状态
   - 更新依赖的API和服务
   - 记录和分析异常模式

通过这套登录功能健康检查系统，您可以及时发现和处理登录相关的问题，确保用户始终能够正常访问系统！🎉 