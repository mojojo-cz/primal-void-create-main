# 管理员密码重置功能说明

## 功能概述

新增的管理员密码重置功能允许具有管理员权限的用户为系统内的其他用户重置密码。该功能通过安全的 Edge Function 实现，确保只有经过验证的管理员才能执行此操作。

## 功能特性

### 🔐 权限控制
- **只有管理员可见**：重置密码按钮仅对 `user_type` 为 `admin` 的用户显示
- **服务端验证**：Edge Function 会再次验证操作者是否为管理员
- **安全隔离**：使用独立的 Edge Function 处理密码重置，避免在前端暴露敏感操作

### 🛡️ 安全措施
- **密码强度要求**：新密码必须至少 6 位字符
- **二次确认**：需要输入两次新密码确保一致性
- **操作日志**：所有密码重置操作都会在服务端记录日志
- **即时生效**：密码重置后立即生效，用户需使用新密码登录

### 📱 用户体验
- **直观界面**：在账户管理页面的操作列中显示橙色的"重置密码"按钮
- **详细反馈**：提供清晰的成功/失败提示信息
- **安全提示**：在重置对话框中显示安全注意事项

## 使用方法

### 步骤 1：访问账户管理页面
1. 使用管理员账户登录系统
2. 导航到 `/admin/accounts` 页面
3. 在用户列表中找到需要重置密码的用户

### 步骤 2：执行密码重置
1. 点击目标用户行的"重置密码"按钮（橙色，带钥匙图标）
2. 在弹出的对话框中确认用户信息
3. 输入新密码（至少 6 位字符）
4. 再次输入新密码进行确认
5. 点击"确认重置"按钮

### 步骤 3：通知用户
- 密码重置成功后，建议通过安全渠道通知用户新密码
- 提醒用户在首次登录后及时修改密码

## 技术实现

### Edge Function
```typescript
// Edge Function: admin-reset-password
// 位置: Supabase Edge Functions
// 功能: 验证管理员权限并重置用户密码
```

### 前端组件
```typescript
// 组件: AccountManagement.tsx
// 位置: src/pages/admin/AccountManagement.tsx
// 新增功能:
// - 重置密码按钮 (仅管理员可见)
// - 重置密码对话框
// - 密码验证逻辑
// - Edge Function 调用
```

## 安全注意事项

### ⚠️ 重要提醒
1. **权限管理**：确保只有可信任的用户具有管理员权限
2. **密码安全**：建议为用户设置临时密码，要求其首次登录后修改
3. **操作记录**：所有密码重置操作都会被记录，便于审计
4. **通信安全**：通过安全渠道（如加密邮件、内部系统）通知用户新密码

### 🔧 系统要求
- Supabase 项目必须配置服务角色密钥 (Service Role Key)
- Edge Function 必须部署并处于活动状态
- 管理员用户必须具有有效的 `admin` 用户类型

## 错误处理

### 常见错误及解决方案

#### 1. "服务角色密钥未配置"
- **原因**：Supabase 项目未设置服务角色密钥
- **解决**：在 Supabase 控制台的项目设置中配置 `SUPABASE_SERVICE_ROLE_KEY`

#### 2. "权限不足：只有管理员才能重置用户密码"
- **原因**：当前用户不是管理员或权限验证失败
- **解决**：确认当前用户的 `user_type` 为 `admin`

#### 3. "调用密码重置服务失败"
- **原因**：Edge Function 调用失败或网络问题
- **解决**：检查网络连接和 Edge Function 状态

## 维护建议

### 定期检查
1. **权限审计**：定期检查管理员用户列表
2. **日志监控**：监控密码重置操作日志
3. **功能测试**：定期测试密码重置功能是否正常

### 安全加固
1. 考虑添加操作确认邮件
2. 实施密码重置频率限制
3. 添加更详细的操作日志记录

## 更新记录

- **v1.0** (2025-01-28): 初始版本，基本密码重置功能
  - 添加管理员权限验证
  - 实现 Edge Function 后端处理
  - 创建用户友好的前端界面
  - 实施基本安全措施 