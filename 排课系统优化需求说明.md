# 排课系统优化需求说明

## 1. 核心目标

本次优化的核心目标是将现有的"创建排课"功能，从一个简单的、单次录入的工具，升级为一个功能强大、逻辑严谨、体验流畅的**智能排课工作台 (Smart Scheduling Workbench)**。新系统需要能够高效处理单次排课、批量周期性排课，并能对参与学员进行宏观和微观的精细化管理。

---

## 2. "创建排课"界面最终设计方案："智能排课工作台"

放弃传统的"单次/批量"模式切换，采用一个统一的、所见即所得的"排课预览与构建器"交互模型。

### 2.1. 界面整体布局

对话框将分为三个核心区域：顶部的**排课生成器**，中部的**课程预览列表**，以及底部的**最终操作区**。

#### **A. 顶部：排课生成器 (Schedule Generator)**

此区域用于定义和生成课程，但不直接保存到数据库。

1.  **课表 (排课计划) - `[核心概念]`**:
    *   **实现方式**: 使用一个**组合框 (Combobox)** 组件。
    *   **功能**: 允许用户从下拉列表中**选择一个已有的课表**，或直接输入文字来**创建一个新的课表**。
    *   **定位**: 表单最顶部，是所有后续操作的上下文容器。

2.  **计划级参与者 (Plan-Level Participants) - `[第一级学员管理]`**:
    *   **班级**: 保留现有的班级选择下拉框，作为主要的参与方。
    *   **额外学员**: 在"班级"下方新增一个**可搜索、可多选的学员组合框**。用于添加需要**全程参与**此课表计划的非本班学员。

3.  **课程信息**:
    *   **本节主题**: 替代原"课程标题"，用于描述单次课的具体内容。
    *   **任课老师**: 保留选择。
    *   **上课教室**: 设为**可选**字段。

4.  **排课工具 (可切换视图)**:
    *   **单次添加**:
        *   **上课日期**: 日期选择器。
        *   **开始时间/结束时间**: 使用原生 `type="time"` 输入框，系统**自动计算并实时显示课程时长**。
    *   **批量添加**:
        *   **重复频率**: 下拉框，提供"每天"、"每周"选项。
        *   **每周重复日**: 当频率为"每周"时显示，提供周一至周日的多选按钮。
        *   **重复时间范围**: 提供"从"和"到"两个日期选择器。
        *   **开始时间/结束时间**: 同单次添加。

5.  **操作按钮**:
    *   **主按钮**: `添加到预览`。点击后，根据生成器中的规则，在下方的预览列表中生成课程条目，并清空部分生成器表单。
    *   **移除字段**: 彻底移除原有的"课时"和"在线会议链接"字段。

#### **B. 中部：课程预览列表 (Schedule Preview List)**

这是交互的核心，以"所见即所得"的方式展示即将被创建的所有课程。

1.  **列表项**: 每一行代表一节待创建的课。
2.  **显示信息**: 清晰展示每节课的**上课日期、星期几、时间、本节主题**。
3.  **单课级参与者 (Instance-Level Participants) - `[第二级学员管理]`**:
    *   **管理学员按钮**: 每行提供一个"学员"图标或按钮。
    *   **管理学员对话框**: 点击后弹出。对话框需清晰列出并可管理三类学员：
        *   **来自班级的学员** (默认带入，通常不可编辑)。
        *   **计划级额外学员** (默认带入，可临时从本节课移除)。
        *   **本节课临时学员** (可在此处搜索并添加仅参与本节课的学员)。
4.  **行操作**: 每行提供独立的**编辑**和**移除**按钮，允许用户对预览列表中的任何一项进行微调或删除。

#### **C. 底部：最终操作区 (Final Actions)**

1.  **汇总信息**: 清晰地显示，例如："总计：本次将创建 25 节课"。
2.  **主操作按钮**: `保存计划`。点击后，才会将预览列表中的所有课程数据一次性提交到数据库。

---

## 3. 对现有视图的同步优化要求

为了支撑新的数据模型和工作流，现有的排课管理视图必须升级。

### 3.1. 表格视图 (Table View) 优化

1.  **层级结构**:
    *   **默认视图**: 按**"课表计划"**进行分组，每个计划作为可折叠的组标题。
    *   **筛选**: 在顶部筛选区增加**"课表计划"下拉筛选器**。
2.  **信息展示**:
    *   **"班级"列 -> "参与方"列**: 智能显示内容，如"高三(1)班 + 2名额外学员"。
    *   **信息浮层 (Popover)**: 鼠标悬停或点击"参与方"单元格时，弹出浮层，分点列出**班级成员、计划级学员、本节课临时学员**的详细名单。
3.  **上下文操作**:
    *   在每个"课表计划"的组标题行，增加针对整个计划的操作按钮，如：**编辑计划、添加课程到计划、管理计划学员**。

### 3.2. 日历视图 (Calendar View) 优化

1.  **视觉区分**:
    *   **筛选**: 在日历上方增加**"课表计划"筛选器**。
    *   **颜色编码**: 系统为每个"课表计划"自动分配一种独特颜色，日历事件根据所属计划显示对应颜色。
2.  **信息密度**:
    *   **增强信息浮层**: 重新设计点击或悬停日历事件时出现的浮层，需清晰展示：
        *   所属计划
        *   本节主题
        *   时间
        *   教师
        *   参与学员 (点击后可展开三类学员的详细列表)

---

## 4. 关键流程与冲突处理

### 4.1. 用户核心操作流程 (示例)

1.  **打开工作台**，选择或创建一个"课表计划"。
2.  **设置计划级参与者** (如：高三(1)班 + 学员李四)。
3.  使用**批量生成器**，添加"每周一、三、五"的常规课程到预览列表。
4.  在**预览列表**中，找到国庆节的课程并**移除**。
5.  切换到**单次生成器**，添加一次周六的补课到预览列表。
6.  在预览列表中找到某节课，点击**"管理学员"**，为该节课**临时添加**一个试听学员王五。
7.  确认预览列表无误后，点击**"保存计划"**，完成所有操作。

### 4.2. 冲突处理机制

*   在点击"保存计划"进行批量创建时，后端需要进行冲突检测（如教师、教室在同一时间被占用）。
*   **处理方案**: 提示有冲突的条目，必须解决全部冲突的条目后，才能继续创建课程。